<!DOCTYPE html>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZARA | Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ========== RESET E BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

```
    /* Reset global para bot√µes com √≠cones SVG */
    button {
        font-family: inherit;
        background: transparent;
    }

    button svg {
        fill: none;
        pointer-events: none;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: #0a0a0a;
        min-height: 100vh;
        padding: 20px;
        color: #fff;
    }

    /* Linhas decorativas superior/inferior */
    body::before, body::after {
        content: '';
        position: fixed;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, #d4af7d, transparent);
        z-index: 9999;
    }
    body::before { top: 0; }
    body::after { bottom: 0; }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* ========== HEADER ========== */
    .header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(212, 175, 125, 0.15);
    }

    .btn-voltar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 1px solid rgba(212, 175, 125, 0.3);
        background: transparent;
        color: #d4af7d;
        font-size: 1.3em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.3s;
    }

    .btn-voltar:hover {
        background: rgba(212, 175, 125, 0.1);
        transform: scale(1.05);
    }

    .header-title h1 {
        font-family: 'Playfair Display', serif;
        font-size: 1.9em;
        font-weight: 400;
        color: #fff;
        letter-spacing: 2px;
    }

    .header-title p {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9em;
        margin-top: 4px;
    }

    /* ========== SELETOR DE M√äS ========== */
    .mes-selector {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #141414;
        border: 1px solid rgba(212, 175, 125, 0.15);
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 25px;
    }

    .mes-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .mes-label {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9em;
    }

    .mes-selector select {
        background: #1a1a1a;
        border: 1px solid rgba(212, 175, 125, 0.3);
        color: #d4af7d;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        outline: none;
    }

    .mes-selector select:focus {
        border-color: #d4af7d;
    }

    .mes-selector select option {
        background: #1a1a1a;
        color: #fff;
    }

    .view-toggle {
        display: flex;
        gap: 10px;
    }

    .view-toggle button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s;
    }

    .view-toggle button:hover {
        background: rgba(212, 175, 125, 0.1);
        border-color: rgba(212, 175, 125, 0.3);
    }

    .view-toggle button.active {
        background: rgba(212, 175, 125, 0.15);
        border-color: #d4af7d;
        color: #d4af7d;
    }

    /* Bot√µes de navega√ß√£o de per√≠odo */
    .btn-periodo-nav {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: rgba(255, 255, 255, 0.6);
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.3s;
    }

    .btn-periodo-nav:hover {
        background: rgba(212, 175, 125, 0.15) !important;
        border-color: rgba(212, 175, 125, 0.3) !important;
        color: #d4af7d;
    }

    .btn-periodo-hoje {
        background: rgba(212, 175, 125, 0.1) !important;
        border: 1px solid rgba(212, 175, 125, 0.3) !important;
        color: #d4af7d;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-periodo-hoje:hover {
        background: rgba(212, 175, 125, 0.2) !important;
        border-color: #d4af7d !important;
    }

    /* ========== RESUMO GRID ========== */
    .resumo-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 30px;
    }

    .resumo-card {
        background: #141414;
        border: 1px solid rgba(212, 175, 125, 0.15);
        border-radius: 15px;
        padding: 22px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .resumo-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
    }

    .resumo-card.recebido::before { background: linear-gradient(90deg, #27ae60, #2ecc71); }
    .resumo-card.pago::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }
    .resumo-card.despesas-mes::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
    .resumo-card.economia::before { background: linear-gradient(90deg, #3498db, #2980b9); }

    .resumo-card label {
        display: block;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8em;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
    }

    .resumo-card .valor {
        font-size: 1.7em;
        font-weight: 600;
        color: #fff;
    }

    .resumo-card.recebido .valor { color: #2ecc71; }
    .resumo-card.pago .valor { color: #e74c3c; }
    .resumo-card.despesas-mes .valor { color: #9b59b6; }
    .resumo-card.economia .valor { color: #3498db; }

    /* ========== SE√á√ïES ========== */
    .section {
        background: #141414;
        border: 1px solid rgba(212, 175, 125, 0.15);
        border-radius: 15px;
        margin-bottom: 25px;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
        border-bottom: 1px solid rgba(212, 175, 125, 0.15);
    }

    .section-header h2 {
        font-family: 'Playfair Display', serif;
        font-size: 1.25em;
        font-weight: 400;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-header .subtotal {
        font-family: 'Inter', sans-serif;
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 400;
    }

    .btn-add {
        background: rgba(212, 175, 125, 0.12);
        border: 1px solid rgba(212, 175, 125, 0.3);
        color: #d4af7d;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-add:hover {
        background: rgba(212, 175, 125, 0.25);
        transform: translateY(-1px);
    }

    .section-content {
        padding: 20px 25px;
    }

    /* ========== TABELAS (Layout igual saude.html) ========== */
    .table-container {
        overflow-x: auto;
    }

    .transacoes-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }

    .transacoes-table th {
        text-align: center;
        padding: 16px 12px;
        color: #d4af7d;
        font-size: 0.8em;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        border-bottom: 1px solid rgba(212, 175, 125, 0.2);
        background: transparent;
    }

    .transacoes-table td {
        padding: 18px 12px;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 1em;
        text-align: center;
        vertical-align: middle;
    }

    /* Colunas espec√≠ficas */
    .col-status { width: 60px; }
    .col-descricao { text-align: left !important; }
    .col-acoes { width: 160px; }

    .transacoes-table tbody tr {
        transition: background 0.2s;
    }

    .transacoes-table tbody tr:hover {
        background: rgba(212, 175, 125, 0.05);
    }

    .transacoes-table tr.done {
        opacity: 0.5;
    }

    .transacoes-table tr.done td {
        text-decoration: none;
    }

    .transacoes-table tr.vencido {
        background: rgba(231, 76, 60, 0.08);
    }

    .transacoes-table tr.proximo {
        background: rgba(241, 196, 15, 0.08);
    }

    /* C√©lula de descri√ß√£o */
    .transacoes-table .descricao {
        text-align: left;
        font-weight: 400;
        font-size: 1em;
        color: #fff;
    }

    /* Categoria badge */
    .categoria {
        display: inline-block;
        padding: 5px 12px;
        background: rgba(212, 175, 125, 0.1);
        border-radius: 15px;
        font-size: 0.85em;
        color: #d4af7d;
        font-weight: 400;
    }

    /* Valores coloridos */
    .valor-positivo { 
        color: #2ecc71 !important; 
        font-weight: 500; 
        font-size: 1em; 
    }
    .valor-negativo { 
        color: #e74c3c !important; 
        font-weight: 500; 
        font-size: 1em; 
    }
    .valor-economia { 
        color: #3498db !important; 
        font-weight: 500; 
        font-size: 1em; 
    }

    /* ========== BOT√ïES DE A√á√ÉO (Estilo saude.html) ========== */
    .acoes {
        display: flex;
        gap: 5px;
        justify-content: center;
        align-items: center;
    }

    .btn-add {
        background: transparent;
        color: #d4af7d;
        padding: 5px;
        border: none;
        cursor: pointer;
        font-size: 1.5em;
        font-weight: bold;
        transition: all 0.2s;
    }

    .btn-add:hover {
        transform: scale(1.2);
    }

    .btn-edit {
        background: transparent;
        color: #d4af7d;
        padding: 5px;
        border: none;
        cursor: pointer;
        font-size: 1.3em;
        transition: transform 0.2s;
    }

    .btn-edit:hover {
        transform: scale(1.2);
    }

    .btn-delete {
        background: transparent;
        color: rgba(220, 53, 69, 0.7);
        padding: 5px;
        border: none;
        cursor: pointer;
        font-size: 1.3em;
        transition: all 0.2s;
    }

    .btn-delete:hover {
        transform: scale(1.2);
        color: #dc3545;
    }

    .btn-duplicate {
        background: transparent;
        color: rgba(212, 175, 125, 0.6);
        padding: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-duplicate:hover {
        transform: scale(1.2);
        color: #d4af7d;
    }

    .btn-comprovante {
        background: transparent;
        color: rgba(46, 204, 113, 0.7);
        padding: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-comprovante:hover {
        transform: scale(1.2);
        color: #2ecc71;
    }

    .btn-arquivar {
        background: transparent;
        color: rgba(149, 165, 166, 0.7);
        padding: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-arquivar:hover {
        transform: scale(1.2);
        color: #95a5a6;
    }

    /* Action buttons container */
    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
        align-items: center;
    }

    .action-buttons button {
        background: transparent !important;
        background-color: transparent !important;
        border: none;
        padding: 5px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .action-buttons button:hover {
        transform: scale(1.2);
        background: transparent !important;
    }

    .action-buttons button svg {
        fill: none;
        background: transparent;
    }

    /* Reset geral para bot√µes com SVG */
    button.btn-edit,
    button.btn-delete,
    button.btn-arquivar,
    button.btn-comprovante {
        background: transparent !important;
        background-color: transparent !important;
        border: none !important;
        outline: none !important;
    }

    /* ========== BADGES ========== */
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.7em;
        font-weight: 400;
        margin-left: 8px;
        vertical-align: middle;
    }

    .badge.recorrente { background: rgba(155, 89, 182, 0.15); color: #9b59b6; }
    .badge.parcela { background: rgba(52, 152, 219, 0.15); color: #3498db; }
    .badge.vencido { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
    .badge.proximo { background: rgba(241, 196, 15, 0.15); color: #f1c40f; }
    .badge.arquivado { background: rgba(149, 165, 166, 0.15); color: #95a5a6; }
    .badge.comprovante { background: rgba(46, 204, 113, 0.15); color: #2ecc71; }
    .badge.juros-pendente { background: rgba(243, 156, 18, 0.15); color: #f39c12; }

    /* ========== CHECKBOX STATUS (igual saude.html) ========== */
    .checkbox-status {
        appearance: none;
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        border: 2px solid #2ecc71;
        border-radius: 50%;
        cursor: pointer;
        background: transparent;
        transition: all 0.2s;
        position: relative;
    }

    /* Checkbox de formul√°rio (Parcelado?) */
    .form-group-checkbox {
        display: flex;
        align-items: center;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.95em;
    }

    .checkbox-label input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(212, 175, 125, 0.5);
        border-radius: 4px;
        cursor: pointer;
        background: transparent;
        transition: all 0.2s;
        position: relative;
    }

    .checkbox-label input[type="checkbox"]:checked {
        background: #d4af7d;
        border-color: #d4af7d;
    }

    .checkbox-label input[type="checkbox"]:checked::after {
        content: '‚úì';
        position: absolute;
        color: #0a0a0a;
        font-size: 12px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .parcelas-field.hidden {
        display: none !important;
    }

    /* Barra de progresso de parcelas */
    .parcela-progress {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: 4px;
    }

    .parcela-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75em;
    }

    .parcela-info .parcela-label {
        color: #3498db;
        font-weight: 500;
    }

    .parcela-info .parcela-percent {
        color: rgba(255, 255, 255, 0.6);
    }

    .parcela-bar {
        width: 100%;
        height: 6px;
        background: rgba(52, 152, 219, 0.2);
        border-radius: 3px;
        overflow: hidden;
    }

    .parcela-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #2980b9 0%, #3498db 100%);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .checkbox-status:hover {
        background: rgba(46, 204, 113, 0.1);
    }

    .checkbox-status:checked {
        background: #2ecc71;
    }

    .checkbox-status:checked::after {
        content: '‚úì';
        position: absolute;
        color: #0a0a0a;
        font-size: 12px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
        text-align: center;
        padding: 45px 20px;
        color: rgba(255, 255, 255, 0.3);
        font-size: 0.95em;
    }

    /* ========== FORMUL√ÅRIOS ========== */
    .form-container {
        display: none;
        background: #1a1a1a;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid rgba(212, 175, 125, 0.1);
    }

    .form-container.active {
        display: block;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 18px;
        margin-bottom: 18px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select {
        padding: 13px 16px;
        background: #141414;
        border: 1px solid rgba(212, 175, 125, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 1em;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #d4af7d;
    }

    .form-group input::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }

    .form-group select option {
        background: #141414;
        color: #fff;
    }

    .form-group input[type="file"] {
        padding: 11px;
        font-size: 0.9em;
    }

    .form-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 22px;
    }

    .btn-salvar {
        background: #d4af7d;
        color: #0a0a0a;
        border: none;
        padding: 13px 28px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-salvar:hover {
        background: #c9a066;
        transform: translateY(-1px);
    }

    .btn-cancelar {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.6);
        border: none;
        padding: 13px 22px;
        border-radius: 8px;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancelar:hover {
        background: rgba(255, 255, 255, 0.12);
    }

    /* ========== PROGRESS BAR ========== */
    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    /* ========== EMPR√âSTIMOS CARD ========== */
    .emprestimo-card {
        background: #1a1a1a;
        border: 1px solid rgba(155, 89, 182, 0.25);
        border-radius: 15px;
        padding: 22px;
        margin-bottom: 20px;
    }

    .emprestimo-card.arquivado {
        opacity: 0.5;
        border-color: rgba(149, 165, 166, 0.25);
    }

    .emprestimo-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .emprestimo-card-title {
        font-size: 1.15em;
        color: #fff;
        font-weight: 500;
    }

    .emprestimo-card-title small {
        display: block;
        font-size: 0.75em;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 400;
        margin-top: 6px;
    }

    .emprestimo-card-acoes {
        display: flex;
        gap: 8px;
    }

    .emprestimo-card-acoes button {
        background: transparent !important;
        background-color: transparent !important;
        border: none !important;
        padding: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .emprestimo-card-acoes button:hover {
        transform: scale(1.2);
        background: transparent !important;
    }

    .emprestimo-card-acoes button svg {
        fill: none;
    }

    .emprestimo-card-acoes .btn-edit {
        color: #d4af7d;
    }

    .emprestimo-card-acoes .btn-delete {
        color: rgba(220, 53, 69, 0.7);
    }

    .emprestimo-card-acoes .btn-delete:hover {
        color: #dc3545;
    }

    .emprestimo-valores {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }

    .emprestimo-valor-item {
        background: rgba(0, 0, 0, 0.25);
        padding: 16px;
        border-radius: 10px;
        text-align: center;
    }

    .emprestimo-valor-item label {
        display: block;
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        margin-bottom: 8px;
        letter-spacing: 0.5px;
    }

    .emprestimo-valor-item .valor {
        font-size: 1.15em;
        font-weight: 600;
    }

    .emprestimo-valor-item .valor.principal { color: #9b59b6; }
    .emprestimo-valor-item .valor.juros-acum { color: #f39c12; }
    .emprestimo-valor-item .valor.juros-pagos { color: #27ae60; }
    .emprestimo-valor-item .valor.amortizado { color: #3498db; }
    .emprestimo-valor-item .valor.saldo { color: #e74c3c; }

    .emprestimo-progress label {
        font-size: 0.8em;
        color: rgba(255, 255, 255, 0.5);
    }

    .emprestimo-acoes-rapidas {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 18px;
    }

    .emprestimo-acoes-rapidas button {
        padding: 13px;
        border-radius: 10px;
        font-size: 0.9em;
        cursor: pointer;
        border: none;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-gerar-juros {
        background: rgba(155, 89, 182, 0.15);
        color: #9b59b6;
        border: 1px solid rgba(155, 89, 182, 0.3) !important;
    }
    .btn-gerar-juros:hover { background: rgba(155, 89, 182, 0.25); }

    .btn-juros {
        background: rgba(243, 156, 18, 0.15);
        color: #f39c12;
        border: 1px solid rgba(243, 156, 18, 0.3) !important;
    }
    .btn-juros:hover { background: rgba(243, 156, 18, 0.25); }

    .btn-amortizar {
        background: rgba(52, 152, 219, 0.15);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3) !important;
    }
    .btn-amortizar:hover { background: rgba(52, 152, 219, 0.25); }

    /* ========== RESUMO FINAL ========== */
    .resumo-final {
        background: linear-gradient(135deg, #1a1a1a 0%, #141414 100%);
        border: 1px solid rgba(212, 175, 125, 0.2);
        border-radius: 18px;
        padding: 28px;
        margin-top: 30px;
    }

    .resumo-final h3 {
        font-family: 'Playfair Display', serif;
        font-size: 1.3em;
        color: #d4af7d;
        margin-bottom: 22px;
        text-align: center;
        letter-spacing: 2px;
    }

    .resumo-final-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }

    .resumo-final-item {
        text-align: center;
        padding: 22px;
        background: rgba(0, 0, 0, 0.25);
        border-radius: 12px;
    }

    .resumo-final-item label {
        display: block;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.8em;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
    }

    .resumo-final-item .valor {
        font-size: 1.9em;
        font-weight: 600;
    }

    .resumo-final-item.recebido .valor { color: #2ecc71; }
    .resumo-final-item.pago .valor { color: #e74c3c; }
    .resumo-final-item.economia .valor { color: #3498db; }

    /* ========== BALAN√áO GERAL ========== */
    .balanco-geral {
        background: linear-gradient(135deg, #1a1a1a 0%, #141414 100%);
        border: 1px solid rgba(212, 175, 125, 0.25);
        border-radius: 20px;
        padding: 30px;
        margin-top: 30px;
    }

    .balanco-geral h3 {
        font-family: 'Playfair Display', serif;
        font-size: 1.4em;
        color: #d4af7d;
        margin-bottom: 25px;
        text-align: center;
        letter-spacing: 2px;
    }

    .balanco-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
        margin-bottom: 25px;
    }

    .balanco-item {
        background: rgba(0, 0, 0, 0.25);
        border-radius: 12px;
        padding: 20px;
        border-left: 3px solid transparent;
    }

    .balanco-item.alerta { border-left-color: #e74c3c; }
    .balanco-item.sucesso { border-left-color: #2ecc71; }
    .balanco-item.info { border-left-color: #3498db; }

    .balanco-item h4 {
        font-size: 0.85em;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
    }

    .balanco-item .valor-destaque {
        font-size: 1.5em;
        font-weight: 600;
        color: #fff;
        margin-bottom: 6px;
    }

    .balanco-item .detalhe {
        font-size: 0.9em;
        color: rgba(255, 255, 255, 0.5);
    }

    .sugestoes-container {
        background: rgba(212, 175, 125, 0.08);
        border: 1px solid rgba(212, 175, 125, 0.2);
        border-radius: 12px;
        padding: 22px;
    }

    .sugestoes-container h4 {
        font-size: 1em;
        color: #d4af7d;
        margin-bottom: 18px;
    }

    .sugestao-item {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 14px 18px;
        margin-bottom: 12px;
        font-size: 0.95em;
        color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .sugestao-item:last-child {
        margin-bottom: 0;
    }

    .sugestao-item .icon {
        font-size: 1.2em;
        flex-shrink: 0;
    }

    /* ========== MODAIS ========== */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #141414;
        border: 1px solid rgba(212, 175, 125, 0.2);
        border-radius: 20px;
        padding: 0;
        max-width: 550px;
        width: 100%;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 22px 28px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
        font-family: 'Playfair Display', serif;
        color: #d4af7d;
        font-size: 1.3em;
    }

    .modal-close {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 1.8em;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        transition: color 0.3s;
    }

    .modal-close:hover {
        color: #fff;
    }

    .modal-body {
        padding: 25px 28px;
        overflow-y: auto;
    }

    .info-box {
        background: rgba(212, 175, 125, 0.1);
        border: 1px solid rgba(212, 175, 125, 0.2);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 0.95em;
        color: rgba(255, 255, 255, 0.7);
    }

    .info-box strong {
        color: #d4af7d;
    }

    .info-box.warning {
        background: rgba(243, 156, 18, 0.1);
        border-color: rgba(243, 156, 18, 0.25);
    }

    .info-box.info {
        background: rgba(52, 152, 219, 0.1);
        border-color: rgba(52, 152, 219, 0.25);
    }

    /* ========== STATUS SYNC ========== */
    #syncStatus {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 22px;
        border-radius: 10px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 10001;
        opacity: 0;
        transition: opacity 0.3s;
        color: #fff;
    }

    /* ========== RESPONSIVO ========== */
    @media (max-width: 900px) {
        .resumo-grid { grid-template-columns: repeat(2, 1fr); }
        .emprestimo-acoes-rapidas { grid-template-columns: 1fr; }
        .resumo-final-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 600px) {
        body { padding: 15px; }
        .header-title h1 { font-size: 1.5em; }
        .resumo-grid { gap: 10px; }
        .resumo-card { padding: 16px; }
        .resumo-card .valor { font-size: 1.4em; }
        .mes-selector { flex-direction: column; gap: 15px; align-items: stretch; }
        .view-toggle { justify-content: center; }
        .section-header { flex-direction: column; gap: 15px; align-items: stretch; }
        .btn-add { width: 100%; text-align: center; }
        .section-content { padding: 15px; }
        .form-row { grid-template-columns: 1fr; }
        .balanco-grid { grid-template-columns: 1fr; }
        .acoes { flex-wrap: wrap; }
    }
</style>
```

</head>
<body>
    <div class="container">

```
    <!-- HEADER -->
    <div class="header">
        <a href="index.html" class="btn-voltar">‚Üê</a>
        <div class="header-title">
            <h1>Planejamento Financeiro</h1>
            <p>Controle suas finan√ßas com intelig√™ncia</p>
        </div>
    </div>

    <!-- SELETOR DE M√äS/ANO E VISUALIZA√á√ÉO -->
    <div class="mes-selector">
        <div class="mes-controls">
            <span class="mes-label">Per√≠odo:</span>
            <select id="mesSelect">
                <option value="01">Janeiro</option>
                <option value="02">Fevereiro</option>
                <option value="03">Mar√ßo</option>
                <option value="04">Abril</option>
                <option value="05">Maio</option>
                <option value="06">Junho</option>
                <option value="07">Julho</option>
                <option value="08">Agosto</option>
                <option value="09">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <select id="anoSelect">
                <!-- Anos ser√£o gerados dinamicamente -->
            </select>
            <button class="btn-periodo-nav" onclick="navegarPeriodo(-1)" title="M√™s anterior">‚óÄ</button>
            <button class="btn-periodo-nav" onclick="navegarPeriodo(1)" title="Pr√≥ximo m√™s">‚ñ∂</button>
            <button class="btn-periodo-hoje" onclick="irParaHoje()" title="Ir para m√™s atual">Hoje</button>
        </div>
        <div class="view-toggle">
            <button class="active" id="btnAtivos">üìã Ativos</button>
            <button id="btnArquivados">üìÅ Arquivados</button>
        </div>
    </div>

    <!-- RESUMO DO M√äS -->
    <div class="resumo-grid">
        <div class="resumo-card recebido">
            <label>üí∞ Recebido</label>
            <div class="valor" id="totalRecebido">R$ 0,00</div>
        </div>
        <div class="resumo-card pago">
            <label>üí∏ Pago</label>
            <div class="valor" id="totalPago">R$ 0,00</div>
        </div>
        <div class="resumo-card despesas-mes">
            <label>üìÖ Despesas do M√™s</label>
            <div class="valor" id="totalDespesasMes">R$ 0,00</div>
        </div>
        <div class="resumo-card economia">
            <label>üè¶ Economizado</label>
            <div class="valor" id="totalEconomia">R$ 0,00</div>
        </div>
    </div>

    <!-- SE√á√ÉO: RECEITAS -->
    <div class="section" id="sectionReceitas">
        <div class="section-header">
            <h2>üìà Receitas</h2>
            <button class="btn-add" id="btnAddReceita">+ Adicionar</button>
        </div>
        <div class="section-content">
            <div id="formReceita" class="form-container"></div>
            <div class="table-container">
                <table class="transacoes-table">
                    <thead>
                        <tr>
                            <th class="col-status">‚úì</th>
                            <th class="col-descricao">Descri√ß√£o</th>
                            <th class="col-categoria">Categoria</th>
                            <th class="col-data">Data</th>
                            <th class="col-valor">Valor</th>
                            <th class="col-acoes">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="receitasTable"></tbody>
                </table>
            </div>
            <div id="emptyReceitas" class="empty-state">Nenhuma receita cadastrada</div>
        </div>
    </div>

    <!-- SE√á√ÉO: DESPESAS FIXAS -->
    <div class="section" id="sectionDespesasFixas">
        <div class="section-header">
            <h2>üè† Despesas Fixas <span class="subtotal" id="subtotalFixas"></span></h2>
            <button class="btn-add" id="btnAddDespesaFixa">+ Adicionar</button>
        </div>
        <div class="section-content">
            <div id="formDespesaFixa" class="form-container"></div>
            <div class="table-container">
                <table class="transacoes-table">
                    <thead>
                        <tr>
                            <th class="col-status">‚úì</th>
                            <th class="col-descricao">Descri√ß√£o</th>
                            <th class="col-categoria">Categoria</th>
                            <th class="col-data">Vencimento</th>
                            <th class="col-valor">Valor</th>
                            <th class="col-acoes">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="despesasFixasTable"></tbody>
                </table>
            </div>
            <div id="emptyDespesasFixas" class="empty-state">Nenhuma despesa fixa cadastrada</div>
        </div>
    </div>

    <!-- SE√á√ÉO: DESPESAS VARI√ÅVEIS -->
    <div class="section" id="sectionDespesasVariaveis">
        <div class="section-header">
            <h2>üõí Despesas Vari√°veis <span class="subtotal" id="subtotalVariaveis"></span></h2>
            <button class="btn-add" id="btnAddDespesaVariavel">+ Adicionar</button>
        </div>
        <div class="section-content">
            <div id="formDespesaVariavel" class="form-container"></div>
            <div class="table-container">
                <table class="transacoes-table">
                    <thead>
                        <tr>
                            <th class="col-status">‚úì</th>
                            <th class="col-descricao">Descri√ß√£o</th>
                            <th class="col-categoria">Categoria</th>
                            <th class="col-data">Data</th>
                            <th class="col-valor">Valor</th>
                            <th class="col-acoes">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="despesasVariaveisTable"></tbody>
                </table>
            </div>
            <div id="emptyDespesasVariaveis" class="empty-state">Nenhuma despesa vari√°vel cadastrada</div>
        </div>
    </div>

    <!-- SE√á√ÉO: EMPR√âSTIMOS / D√çVIDAS -->
    <div class="section" id="sectionEmprestimos">
        <div class="section-header">
            <h2>üè¶ Empr√©stimos / D√≠vidas</h2>
            <button class="btn-add" id="btnAddEmprestimo">+ Adicionar</button>
        </div>
        <div class="section-content">
            <div id="formEmprestimo" class="form-container"></div>
            <div id="emprestimosContainer"></div>
            <div id="emptyEmprestimos" class="empty-state">Nenhum empr√©stimo cadastrado</div>
        </div>
    </div>

    <!-- SE√á√ÉO: ECONOMIAS -->
    <div class="section" id="sectionEconomias">
        <div class="section-header">
            <h2>üíé Economias <span class="subtotal" id="subtotalEconomias"></span></h2>
            <button class="btn-add" id="btnAddEconomia">+ Adicionar</button>
        </div>
        <div class="section-content">
            <div id="formEconomia" class="form-container"></div>
            <div class="table-container">
                <table class="transacoes-table">
                    <thead>
                        <tr>
                            <th class="col-descricao">Descri√ß√£o</th>
                            <th class="col-categoria">Categoria</th>
                            <th class="col-data">Data</th>
                            <th class="col-valor">Valor</th>
                            <th class="col-acoes">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="economiasTable"></tbody>
                </table>
            </div>
            <div id="emptyEconomias" class="empty-state">Nenhuma economia cadastrada</div>
        </div>
    </div>

    <!-- RESUMO GERAL ACUMULADO -->
    <div class="resumo-final">
        <h3>üìä RESUMO GERAL ACUMULADO</h3>
        <div class="resumo-final-grid">
            <div class="resumo-final-item recebido">
                <label>Total Recebido</label>
                <div class="valor" id="totalRecebidoFinal">R$ 0,00</div>
            </div>
            <div class="resumo-final-item pago">
                <label>Total Pago</label>
                <div class="valor" id="totalPagoFinal">R$ 0,00</div>
            </div>
            <div class="resumo-final-item economia">
                <label>Total Economizado</label>
                <div class="valor" id="totalEconomiaFinal">R$ 0,00</div>
            </div>
        </div>
    </div>

    <!-- BALAN√áO GERAL INTELIGENTE -->
    <div class="balanco-geral">
        <h3>üß† BALAN√áO GERAL</h3>
        <div class="balanco-grid" id="balancoGrid"></div>
        <div class="sugestoes-container">
            <h4>üí° Sugest√µes Inteligentes</h4>
            <div id="sugestoesContainer"></div>
        </div>
    </div>

</div>

<!-- MODAIS -->
<div class="modal" id="modalEditar">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Item</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modalEditarBody"></div>
    </div>
</div>

<div class="modal" id="modalPagarJuros">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí∞ Pagar Juros</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modalPagarJurosBody"></div>
    </div>
</div>

<div class="modal" id="modalAmortizar">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìâ Amortizar D√≠vida</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modalAmortizarBody"></div>
    </div>
</div>

<div class="modal" id="modalComprovante">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìé Comprovante</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modalComprovanteBody"></div>
    </div>
</div>

<!-- SCRIPTS ser√£o adicionados na ETAPA 3 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ==========================================
    // CONFIGURA√á√ÉO E INICIALIZA√á√ÉO
    // ==========================================
    
    const SUPABASE_URL = 'https://ltwamldgdwqzyssoukzl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d2FtbGRnZHdxenlzc291a3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NzEzMDUsImV4cCI6MjA4MjQ0NzMwNX0.UVyo0c0BHslB7mCU74Qx8rdo42HA0WPAyDQ6J-FIakE';
    const USER_ID = 'default_user';
    
    let supabaseClient = null;
    let useSupabase = false;
    
    try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        useSupabase = true;
    } catch (e) {
        console.log('Supabase indispon√≠vel, usando localStorage');
    }

    // ==========================================
    // ESTRUTURA DE DADOS
    // ==========================================
    
    const dadosVazios = {
        receitas: [],
        despesasFixas: [],           // Modelos de despesas recorrentes
        despesasFixasMes: {},        // Inst√¢ncias mensais: {"2025-01": [...]}
        despesasVariaveis: [],
        emprestimos: [],
        economias: [],
        arquivados: {
            receitas: [],
            despesasFixas: [],
            despesasVariaveis: [],
            emprestimos: [],
            economias: []
        }
    };

    let financeiro = JSON.parse(localStorage.getItem('financeiro_v5')) || JSON.parse(JSON.stringify(dadosVazios));
    
    // Garantir estrutura completa
    if (!financeiro.arquivados) financeiro.arquivados = JSON.parse(JSON.stringify(dadosVazios.arquivados));
    if (!financeiro.despesasFixasMes) financeiro.despesasFixasMes = {};

    // Estado da aplica√ß√£o
    let mesSelecionado = '';
    let anoSelecionado = new Date().getFullYear();
    let viewMode = 'ativos';
    let itemEditando = null;
    let emprestimoSelecionado = null;

    // ==========================================
    // UTILIT√ÅRIOS
    // ==========================================
    
    function getMesAnoKey() {
        return `${anoSelecionado}-${mesSelecionado}`;
    }

    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', { 
            style: 'currency', 
            currency: 'BRL' 
        }).format(valor || 0);
    }

    function formatarData(data) {
        if (!data) return '-';
        return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
    }

    function getDataVencimento(dia) {
        const d = String(dia).padStart(2, '0');
        return `${anoSelecionado}-${mesSelecionado}-${d}`;
    }

    function filtrarPorMes(lista) {
        return (lista || []).filter(item => 
            item.data?.substring(0, 7) === getMesAnoKey()
        );
    }

    function getStatusVencimento(dataStr, pago) {
        if (pago) return { classe: '', badge: '' };
        
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const vencimento = new Date(dataStr + 'T00:00:00');
        const diffDias = Math.ceil((vencimento - hoje) / 86400000);
        
        if (diffDias < 0) {
            return { 
                classe: 'vencido', 
                badge: `<span class="badge vencido">‚ö†Ô∏è ${Math.abs(diffDias)}d atraso</span>` 
            };
        }
        if (diffDias <= 3) {
            return { 
                classe: 'proximo', 
                badge: `<span class="badge proximo">‚è∞ ${diffDias === 0 ? 'Hoje' : diffDias + 'd'}</span>` 
            };
        }
        return { classe: '', badge: '' };
    }

    function gerarId() {
        return Date.now() + Math.random();
    }

    // ==========================================
    // COMPROVANTES (Base64)
    // ==========================================
    
    async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            if (!file) { resolve(null); return; }
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Criar objeto de comprovante com metadados
    async function criarComprovante(fileInput, tipo, valor, descricao) {
        const file = fileInput?.files?.[0];
        if (!file) return null;
        
        const base64 = await fileToBase64(file);
        return {
            arquivo: base64,
            nomeArquivo: file.name,
            tipoArquivo: file.type,
            dataPagamento: new Date().toISOString(),
            valorPago: valor,
            tipoPagamento: tipo, // 'despesa_fixa', 'despesa_variavel', 'juros', 'amortizacao'
            descricao: descricao
        };
    }

    // Visualizar comprovante com informa√ß√µes completas
    function verComprovante(comprovante) {
        const viewer = document.getElementById('modalComprovanteBody');
        
        // Se for string antiga (apenas base64), compatibilidade
        if (typeof comprovante === 'string') {
            if (comprovante.includes('application/pdf')) {
                viewer.innerHTML = `
                    <embed src="${comprovante}" type="application/pdf" width="100%" height="450px" style="border-radius:8px;">
                    <div class="form-buttons" style="margin-top:15px;">
                        <button class="btn-salvar" onclick="baixarComprovante('${comprovante}', 'comprovante')">‚¨áÔ∏è Baixar</button>
                    </div>
                `;
            } else {
                viewer.innerHTML = `
                    <img src="${comprovante}" style="max-width:100%; border-radius:8px;">
                    <div class="form-buttons" style="margin-top:15px;">
                        <button class="btn-salvar" onclick="baixarComprovante('${comprovante}', 'comprovante')">‚¨áÔ∏è Baixar</button>
                    </div>
                `;
            }
            abrirModal('modalComprovante');
            return;
        }

        // Comprovante com metadados completos
        const tiposLabel = {
            'despesa_fixa': 'üè† Despesa Fixa',
            'despesa_variavel': 'üõí Despesa Vari√°vel',
            'juros': 'üí∞ Pagamento de Juros',
            'amortizacao': 'üìâ Amortiza√ß√£o'
        };

        let previewHTML = '';
        if (comprovante.arquivo.includes('application/pdf')) {
            previewHTML = `<embed src="${comprovante.arquivo}" type="application/pdf" width="100%" height="350px" style="border-radius:8px;">`;
        } else {
            previewHTML = `<img src="${comprovante.arquivo}" style="max-width:100%; border-radius:8px; max-height:350px; object-fit:contain;">`;
        }

        viewer.innerHTML = `
            <div class="info-box" style="margin-bottom:15px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><strong>Tipo:</strong> ${tiposLabel[comprovante.tipoPagamento] || comprovante.tipoPagamento}</div>
                    <div><strong>Valor:</strong> ${formatarMoeda(comprovante.valorPago)}</div>
                    <div><strong>Data:</strong> ${formatarData(comprovante.dataPagamento?.split('T')[0])}</div>
                    <div><strong>Arquivo:</strong> ${comprovante.nomeArquivo || 'comprovante'}</div>
                </div>
                ${comprovante.descricao ? `<div style="margin-top:8px;"><strong>Ref:</strong> ${comprovante.descricao}</div>` : ''}
            </div>
            ${previewHTML}
            <div class="form-buttons" style="margin-top:15px;">
                <button class="btn-salvar" onclick="baixarComprovanteObj(comprovanteAtual)">‚¨áÔ∏è Baixar Arquivo</button>
            </div>
        `;
        
        // Guardar refer√™ncia para download
        window.comprovanteAtual = comprovante;
        abrirModal('modalComprovante');
    }

    // Baixar comprovante (base64 direto)
    function baixarComprovante(base64, nome) {
        const link = document.createElement('a');
        link.href = base64;
        link.download = nome + (base64.includes('application/pdf') ? '.pdf' : '.jpg');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Baixar comprovante (objeto com metadados)
    function baixarComprovanteObj(comprovante) {
        if (!comprovante?.arquivo) return;
        const link = document.createElement('a');
        link.href = comprovante.arquivo;
        
        // Determinar extens√£o
        let ext = '.jpg';
        if (comprovante.tipoArquivo?.includes('pdf')) ext = '.pdf';
        else if (comprovante.tipoArquivo?.includes('png')) ext = '.png';
        else if (comprovante.nomeArquivo) ext = '.' + comprovante.nomeArquivo.split('.').pop();
        
        link.download = (comprovante.nomeArquivo || 'comprovante_' + comprovante.tipoPagamento) ;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Fun√ß√µes auxiliares para visualizar comprovantes por tipo
    function verComprovanteFixa(id) {
        const key = getMesAnoKey();
        const item = financeiro.despesasFixasMes[key]?.find(d => d.id === id);
        if (item?.comprovante) {
            verComprovante(item.comprovante);
        }
    }

    function verComprovanteVariavel(id) {
        const item = financeiro.despesasVariaveis.find(d => d.id === id);
        if (item?.comprovante) {
            verComprovante(item.comprovante);
        }
    }

    function verComprovanteHistorico(emprestimoId, historicoIdx) {
        const emp = financeiro.emprestimos.find(e => e.id === emprestimoId);
        if (emp?.historico?.[historicoIdx]?.comprovante) {
            verComprovante(emp.historico[historicoIdx].comprovante);
        }
    }

    function verComprovanteHistoricoArquivado(emprestimoId, historicoIdx) {
        // Busca tanto em ativos quanto em arquivados
        let emp = financeiro.emprestimos.find(e => e.id === emprestimoId);
        if (!emp) {
            emp = financeiro.arquivados?.emprestimos?.find(e => e.id === emprestimoId);
        }
        if (emp?.historico?.[historicoIdx]?.comprovante) {
            verComprovante(emp.historico[historicoIdx].comprovante);
        }
    }

    // ==========================================
    // MODAIS
    // ==========================================
    
    function abrirModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function fecharModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // Fechar modal ao clicar no X ou fora
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').classList.remove('active');
        });
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) this.classList.remove('active');
        });
    });

    // ==========================================
    // FORMUL√ÅRIOS DIN√ÇMICOS
    // ==========================================
    
    function criarFormulario(tipo) {
        const configs = {
            receita: {
                campos: [
                    { id: 'receitaDescricao', label: 'Descri√ß√£o', type: 'text', placeholder: 'Ex: Sal√°rio' },
                    { id: 'receitaValor', label: 'Valor', type: 'number', step: '0.01' },
                    { id: 'receitaCategoria', label: 'Categoria', type: 'select', options: ['Sal√°rio', 'Freelance', 'Investimentos', 'Outros'] },
                    { id: 'receitaData', label: 'Data', type: 'date' }
                ]
            },
            despesaFixa: {
                campos: [
                    { id: 'despesaFixaDescricao', label: 'Descri√ß√£o', type: 'text', placeholder: 'Ex: Aluguel' },
                    { id: 'despesaFixaValor', label: 'Valor', type: 'number', step: '0.01' },
                    { id: 'despesaFixaCategoria', label: 'Categoria', type: 'select', options: ['Moradia', 'Internet', 'Energia', '√Ågua', 'Escola', 'Streaming', 'Plano de Sa√∫de', 'Outros'] },
                    { id: 'despesaFixaDia', label: 'Dia Vencimento', type: 'number', min: 1, max: 31, placeholder: '10' }
                ]
            },
            despesaVariavel: {
                campos: [
                    { id: 'despesaVariavelDescricao', label: 'Descri√ß√£o', type: 'text', placeholder: 'Ex: Supermercado' },
                    { id: 'despesaVariavelValor', label: 'Valor da Parcela', type: 'number', step: '0.01' },
                    { id: 'despesaVariavelCategoria', label: 'Categoria', type: 'select', options: ['Alimenta√ß√£o', 'Transporte', 'Lazer', 'Compras', 'Sa√∫de', 'Cart√£o', 'Outros'] },
                    { id: 'despesaVariavelData', label: 'Data', type: 'date' },
                    { id: 'despesaVariavelParcelado', label: 'Parcelado?', type: 'checkbox' },
                    { id: 'despesaVariavelTotalParcelas', label: 'Total de Parcelas', type: 'number', min: '2', max: '48', placeholder: 'Ex: 12' }
                ]
            },
            emprestimo: {
                campos: [
                    { id: 'emprestimoDescricao', label: 'Credor / Descri√ß√£o', type: 'text', placeholder: 'Ex: Banco X' },
                    { id: 'emprestimoPrincipal', label: 'Valor Principal', type: 'number', step: '0.01' },
                    { id: 'emprestimoJuros', label: 'Taxa Juros (%)', type: 'number', step: '0.1', placeholder: '10' },
                    { id: 'emprestimoCategoria', label: 'Categoria', type: 'select', options: ['Agiota', 'Banco', 'Financeira', 'Pessoa F√≠sica', 'Cart√£o', 'Outros'] }
                ]
            },
            economia: {
                campos: [
                    { id: 'economiaDescricao', label: 'Descri√ß√£o', type: 'text', placeholder: 'Ex: Reserva emerg√™ncia' },
                    { id: 'economiaValor', label: 'Valor', type: 'number', step: '0.01' },
                    { id: 'economiaCategoria', label: 'Categoria', type: 'select', options: ['Poupan√ßa', 'Investimento', 'Reserva', 'Objetivo', 'Outros'] },
                    { id: 'economiaData', label: 'Data', type: 'date' }
                ]
            }
        };

        const config = configs[tipo];
        if (!config) return '';

        let html = '<div class="form-row">';
        config.campos.forEach(campo => {
            if (campo.type === 'checkbox') {
                html += `<div class="form-group form-group-checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="${campo.id}" onchange="toggleParcelasField()">
                        <span>${campo.label}</span>
                    </label>
                </div>`;
            } else {
                const isParcelasField = campo.id.includes('TotalParcelas');
                html += `<div class="form-group${isParcelasField ? ' parcelas-field hidden' : ''}"><label>${campo.label}</label>`;
                if (campo.type === 'select') {
                    html += `<select id="${campo.id}"><option value="">Selecione...</option>`;
                    campo.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
                    html += '</select>';
                } else {
                    html += `<input type="${campo.type}" id="${campo.id}"`;
                    if (campo.step) html += ` step="${campo.step}"`;
                    if (campo.min) html += ` min="${campo.min}"`;
                    if (campo.max) html += ` max="${campo.max}"`;
                    if (campo.placeholder) html += ` placeholder="${campo.placeholder}"`;
                    html += '>';
                }
                html += '</div>';
            }
        });
        html += '</div>';
        html += `<div class="form-buttons">
            <button class="btn-cancelar" onclick="esconderForm('${tipo}')">Cancelar</button>
            <button class="btn-salvar" onclick="salvar${tipo.charAt(0).toUpperCase() + tipo.slice(1)}()">Salvar</button>
        </div>`;
        
        return html;
    }

    function toggleParcelasField() {
        const checkbox = document.getElementById('despesaVariavelParcelado');
        const parcelasField = document.querySelector('.parcelas-field');
        if (parcelasField) {
            if (checkbox && checkbox.checked) {
                parcelasField.classList.remove('hidden');
            } else {
                parcelasField.classList.add('hidden');
                const input = parcelasField.querySelector('input');
                if (input) input.value = '';
            }
        }
    }

    function mostrarForm(tipo) {
        const container = document.getElementById('form' + tipo.charAt(0).toUpperCase() + tipo.slice(1));
        if (!container.innerHTML.trim()) {
            container.innerHTML = criarFormulario(tipo);
        }
        container.classList.add('active');
        
        // Preencher data atual
        const dataInput = document.getElementById(tipo + 'Data');
        if (dataInput) dataInput.value = new Date().toISOString().split('T')[0];
    }

    function esconderForm(tipo) {
        const container = document.getElementById('form' + tipo.charAt(0).toUpperCase() + tipo.slice(1));
        container.classList.remove('active');
        container.querySelectorAll('input').forEach(i => i.value = '');
        container.querySelectorAll('select').forEach(s => s.value = '');
    }

    // Event listeners dos bot√µes
    document.getElementById('btnAddReceita').onclick = () => mostrarForm('receita');
    document.getElementById('btnAddDespesaFixa').onclick = () => mostrarForm('despesaFixa');
    document.getElementById('btnAddDespesaVariavel').onclick = () => mostrarForm('despesaVariavel');
    document.getElementById('btnAddEmprestimo').onclick = () => mostrarForm('emprestimo');
    document.getElementById('btnAddEconomia').onclick = () => mostrarForm('economia');

    // ==========================================
    // RECEITAS
    // ==========================================
    
    function salvarReceita() {
        const desc = document.getElementById('receitaDescricao').value.trim();
        const valor = parseFloat(document.getElementById('receitaValor').value) || 0;
        const cat = document.getElementById('receitaCategoria').value || 'Outros';
        const data = document.getElementById('receitaData').value;
        
        if (!desc || !valor || !data) return alert('Preencha todos os campos!');
        
        financeiro.receitas.push({
            id: gerarId(),
            descricao: desc,
            valor: valor,
            categoria: cat,
            data: data,
            recebido: false
        });
        
        salvarDados();
        esconderForm('receita');
        renderizar();
    }

    function toggleRecebido(id) {
        const item = financeiro.receitas.find(r => r.id === id);
        if (item) {
            item.recebido = !item.recebido;
            salvarDados();
            renderizar();
        }
    }

    function deletarReceita(id) {
        if (!confirm('Excluir esta receita?')) return;
        financeiro.receitas = financeiro.receitas.filter(r => r.id !== id);
        salvarDados();
        renderizar();
    }

    function editarReceita(id) {
        const item = financeiro.receitas.find(r => r.id === id);
        if (!item) return;

        itemEditando = { tipo: 'receita', id: id };
        const body = document.getElementById('modalEditarBody');
        body.innerHTML = `
            <div class="form-row">
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="editDescricao" value="${item.descricao}">
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="editValor" step="0.01" value="${item.valor}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="editCategoria" value="${item.categoria}">
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="editData" value="${item.data}">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn-salvar" onclick="salvarEdicaoReceita()">Salvar</button>
            </div>
        `;
        document.querySelector('#modalEditar .modal-header h3').textContent = '‚úèÔ∏è Editar Receita';
        abrirModal('modalEditar');
    }

    function salvarEdicaoReceita() {
        const item = financeiro.receitas.find(r => r.id === itemEditando.id);
        if (item) {
            item.descricao = document.getElementById('editDescricao').value.trim();
            item.valor = parseFloat(document.getElementById('editValor').value) || item.valor;
            item.categoria = document.getElementById('editCategoria').value;
            item.data = document.getElementById('editData').value;
            salvarDados();
        }
        fecharModal('modalEditar');
        renderizar();
    }

    function arquivarReceita(id) {
        const idx = financeiro.receitas.findIndex(r => r.id === id);
        if (idx > -1) {
            const item = financeiro.receitas.splice(idx, 1)[0];
            item.arquivadoEm = new Date().toISOString();
            financeiro.arquivados.receitas.push(item);
            salvarDados();
            renderizar();
            mostrarStatus('Item arquivado', 'success');
        }
    }

    // ==========================================
    // DESPESAS FIXAS (RECORR√äNCIA REAL)
    // ==========================================
    
    function salvarDespesaFixa() {
        const desc = document.getElementById('despesaFixaDescricao').value.trim();
        const valor = parseFloat(document.getElementById('despesaFixaValor').value) || 0;
        const cat = document.getElementById('despesaFixaCategoria').value || 'Outros';
        const dia = parseInt(document.getElementById('despesaFixaDia').value) || 10;
        
        if (!desc || !valor) return alert('Preencha todos os campos!');
        
        // Criar modelo de despesa recorrente
        financeiro.despesasFixas.push({
            id: gerarId(),
            descricao: desc,
            valor: valor,
            categoria: cat,
            diaVencimento: dia,
            ativa: true,
            criadaEm: new Date().toISOString()
        });
        
        salvarDados();
        gerarInstanciasDespesasFixas();
        esconderForm('despesaFixa');
        renderizar();
    }

    // Gera inst√¢ncias mensais das despesas fixas ativas
    function gerarInstanciasDespesasFixas() {
        const key = getMesAnoKey();
        if (!financeiro.despesasFixasMes[key]) {
            financeiro.despesasFixasMes[key] = [];
        }

        financeiro.despesasFixas.filter(df => df.ativa).forEach(modelo => {
            const jaExiste = financeiro.despesasFixasMes[key].some(d => d.modeloId === modelo.id);
            if (!jaExiste) {
                financeiro.despesasFixasMes[key].push({
                    id: gerarId(),
                    modeloId: modelo.id,
                    descricao: modelo.descricao,
                    valor: modelo.valor,
                    categoria: modelo.categoria,
                    data: getDataVencimento(modelo.diaVencimento),
                    pago: false,
                    dataPagamento: null,
                    comprovante: null
                });
            }
        });
        salvarDados();
    }

    function getDespesasFixasMes() {
        return financeiro.despesasFixasMes[getMesAnoKey()] || [];
    }

    function togglePagoFixa(id) {
        const key = getMesAnoKey();
        const item = financeiro.despesasFixasMes[key]?.find(d => d.id === id);
        if (!item) return;

        if (!item.pago) {
            // Abrir modal para registrar pagamento com comprovante
            itemEditando = { tipo: 'despesaFixa', id: id, key: key };
            const body = document.getElementById('modalEditarBody');
            body.innerHTML = `
                <div class="info-box">
                    <strong>${item.descricao}</strong> - ${formatarMoeda(item.valor)}
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data do Pagamento</label>
                        <input type="date" id="pagamentoData" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label>Comprovante (opcional)</label>
                        <input type="file" id="pagamentoComprovante" accept="image/*,.pdf">
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                    <button class="btn-salvar" onclick="confirmarPagamentoDespesa()">Confirmar</button>
                </div>
            `;
            document.querySelector('#modalEditar .modal-header h3').textContent = 'üí≥ Registrar Pagamento';
            abrirModal('modalEditar');
        } else {
            // Desmarcar como pago
            item.pago = false;
            item.dataPagamento = null;
            item.comprovante = null;
            salvarDados();
            renderizar();
        }
    }

    async function confirmarPagamentoDespesa() {
        const data = document.getElementById('pagamentoData').value;
        const fileInput = document.getElementById('pagamentoComprovante');

        if (itemEditando.tipo === 'despesaFixa') {
            const item = financeiro.despesasFixasMes[itemEditando.key]?.find(d => d.id === itemEditando.id);
            if (item) {
                // Criar comprovante com metadados completos
                const comprovante = await criarComprovante(
                    fileInput, 
                    'despesa_fixa', 
                    item.valor, 
                    item.descricao
                );
                
                item.pago = true;
                item.dataPagamento = data;
                item.comprovante = comprovante;
            }
        } else if (itemEditando.tipo === 'despesaVariavel') {
            const item = financeiro.despesasVariaveis.find(d => d.id === itemEditando.id);
            if (item) {
                // Criar comprovante com metadados completos
                const comprovante = await criarComprovante(
                    fileInput, 
                    'despesa_variavel', 
                    item.valor, 
                    item.descricao
                );
                
                item.pago = true;
                item.dataPagamento = data;
                item.comprovante = comprovante;
            }
        }

        salvarDados();
        fecharModal('modalEditar');
        renderizar();
        mostrarStatus('Pagamento registrado', 'success');
    }

    // Editar modelo da despesa fixa (afeta pr√≥ximos meses)
    function editarDespesaFixaModelo(modeloId) {
        const modelo = financeiro.despesasFixas.find(df => df.id === modeloId);
        if (!modelo) return;

        itemEditando = { tipo: 'despesaFixaModelo', id: modeloId };
        const body = document.getElementById('modalEditarBody');
        body.innerHTML = `
            <div class="info-box warning">
                ‚ö†Ô∏è Altera√ß√µes afetam apenas os <strong>pr√≥ximos meses</strong>. O hist√≥rico √© preservado.
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="editDescricao" value="${modelo.descricao}">
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="editValor" step="0.01" value="${modelo.valor}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="editCategoria" value="${modelo.categoria}">
                </div>
                <div class="form-group">
                    <label>Dia Vencimento</label>
                    <input type="number" id="editDia" min="1" max="31" value="${modelo.diaVencimento}">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn-salvar" onclick="salvarEdicaoModelo()">Salvar</button>
            </div>
        `;
        document.querySelector('#modalEditar .modal-header h3').textContent = '‚úèÔ∏è Editar Despesa Fixa';
        abrirModal('modalEditar');
    }

    function salvarEdicaoModelo() {
        const modelo = financeiro.despesasFixas.find(df => df.id === itemEditando.id);
        if (modelo) {
            modelo.descricao = document.getElementById('editDescricao').value.trim();
            modelo.valor = parseFloat(document.getElementById('editValor').value) || modelo.valor;
            modelo.categoria = document.getElementById('editCategoria').value;
            modelo.diaVencimento = parseInt(document.getElementById('editDia').value) || modelo.diaVencimento;
            salvarDados();
        }
        fecharModal('modalEditar');
        renderizar();
    }

    // Encerrar despesa fixa (n√£o aparece mais nos pr√≥ximos meses)
    function encerrarDespesaFixa(modeloId) {
        if (!confirm('Encerrar esta despesa fixa?\nEla n√£o aparecer√° nos pr√≥ximos meses, mas o hist√≥rico ser√° mantido.')) return;
        
        const modelo = financeiro.despesasFixas.find(df => df.id === modeloId);
        if (modelo) {
            modelo.ativa = false;
            modelo.encerradaEm = new Date().toISOString();
            salvarDados();
            renderizar();
            mostrarStatus('Despesa encerrada', 'success');
        }
    }

    // ==========================================
    // DESPESAS VARI√ÅVEIS
    // ==========================================
    
    function salvarDespesaVariavel() {
        const desc = document.getElementById('despesaVariavelDescricao').value.trim();
        const valor = parseFloat(document.getElementById('despesaVariavelValor').value) || 0;
        const cat = document.getElementById('despesaVariavelCategoria').value || 'Outros';
        let data = document.getElementById('despesaVariavelData').value;
        const parcelado = document.getElementById('despesaVariavelParcelado')?.checked || false;
        const totalParcelas = parseInt(document.getElementById('despesaVariavelTotalParcelas')?.value) || 0;
        
        if (!desc || !valor) return alert('Preencha descri√ß√£o e valor!');
        
        // Se n√£o informou data, usa o m√™s/ano selecionado
        if (!data) {
            data = `${anoSelecionado}-${mesSelecionado}-01`;
        }
        
        if (parcelado && totalParcelas >= 2) {
            // Criar despesas parceladas
            const grupoId = gerarId(); // ID √∫nico para agrupar parcelas
            const [ano, mes, dia] = data.split('-').map(Number);
            
            for (let i = 0; i < totalParcelas; i++) {
                // Calcular data de cada parcela (suporta virada de ano)
                let novaMes = mes + i;
                let novoAno = ano;
                
                while (novaMes > 12) {
                    novaMes -= 12;
                    novoAno++;
                }
                
                const dataParcela = `${novoAno}-${String(novaMes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                
                financeiro.despesasVariaveis.push({
                    id: gerarId(),
                    descricao: desc,
                    valor: valor,
                    categoria: cat,
                    data: dataParcela,
                    pago: false,
                    dataPagamento: null,
                    comprovante: null,
                    // Campos de parcela
                    parcelado: true,
                    grupoParcelaId: grupoId,
                    parcelaAtual: i + 1,
                    totalParcelas: totalParcelas
                });
            }
        } else {
            // Despesa √∫nica (n√£o parcelada)
            financeiro.despesasVariaveis.push({
                id: gerarId(),
                descricao: desc,
                valor: valor,
                categoria: cat,
                data: data,
                pago: false,
                dataPagamento: null,
                comprovante: null
            });
        }
        
        salvarDados();
        esconderForm('despesaVariavel');
        renderizar();
    }

    function togglePagoVariavel(id) {
        const item = financeiro.despesasVariaveis.find(d => d.id === id);
        if (!item) return;

        if (!item.pago) {
            itemEditando = { tipo: 'despesaVariavel', id: id };
            const body = document.getElementById('modalEditarBody');
            body.innerHTML = `
                <div class="info-box">
                    <strong>${item.descricao}</strong> - ${formatarMoeda(item.valor)}
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data do Pagamento</label>
                        <input type="date" id="pagamentoData" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label>Comprovante (opcional)</label>
                        <input type="file" id="pagamentoComprovante" accept="image/*,.pdf">
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                    <button class="btn-salvar" onclick="confirmarPagamentoDespesa()">Confirmar</button>
                </div>
            `;
            document.querySelector('#modalEditar .modal-header h3').textContent = 'üí≥ Registrar Pagamento';
            abrirModal('modalEditar');
        } else {
            item.pago = false;
            item.dataPagamento = null;
            item.comprovante = null;
            salvarDados();
            renderizar();
        }
    }

    function deletarDespesaVariavel(id) {
        if (!confirm('Excluir esta despesa?')) return;
        financeiro.despesasVariaveis = financeiro.despesasVariaveis.filter(d => d.id !== id);
        salvarDados();
        renderizar();
    }

    function deletarTodasParcelas(id) {
        const despesa = financeiro.despesasVariaveis.find(d => d.id === id);
        if (!despesa || !despesa.grupoParcelaId) return;
        
        const parcelasDoGrupo = financeiro.despesasVariaveis.filter(d => d.grupoParcelaId === despesa.grupoParcelaId);
        const parcelasPagas = parcelasDoGrupo.filter(p => p.pago).length;
        const parcelasPendentes = parcelasDoGrupo.filter(p => !p.pago).length;
        const totalParcelas = parcelasDoGrupo.length;
        
        // Se houver parcelas pagas, oferecer op√ß√µes
        if (parcelasPagas > 0) {
            const opcao = confirm(
                `"${despesa.descricao}" - ${totalParcelas} parcelas\n\n` +
                `‚úÖ ${parcelasPagas} parcelas j√° pagas\n` +
                `‚è≥ ${parcelasPendentes} parcelas pendentes\n\n` +
                `Clique OK para excluir APENAS as parcelas PENDENTES.\n` +
                `Clique Cancelar para manter tudo.`
            );
            
            if (opcao) {
                // Excluir apenas parcelas pendentes
                financeiro.despesasVariaveis = financeiro.despesasVariaveis.filter(
                    d => d.grupoParcelaId !== despesa.grupoParcelaId || d.pago
                );
                
                // Renumerar parcelas restantes (pagas)
                const restantes = financeiro.despesasVariaveis.filter(d => d.grupoParcelaId === despesa.grupoParcelaId);
                restantes.forEach((p, idx) => {
                    p.totalParcelas = restantes.length;
                });
                
                salvarDados();
                renderizar();
            }
        } else {
            // Sem parcelas pagas - pode excluir tudo
            if (!confirm(`Excluir TODAS as ${totalParcelas} parcelas de "${despesa.descricao}"?`)) return;
            
            financeiro.despesasVariaveis = financeiro.despesasVariaveis.filter(d => d.grupoParcelaId !== despesa.grupoParcelaId);
            salvarDados();
            renderizar();
        }
    }

    function editarDespesaVariavel(id) {
        const item = financeiro.despesasVariaveis.find(d => d.id === id);
        if (!item) return;

        itemEditando = { tipo: 'despesaVariavelEdit', id: id };
        const body = document.getElementById('modalEditarBody');
        
        // Se for parcelada, mostrar op√ß√µes de edi√ß√£o de parcelas
        if (item.parcelado && item.grupoParcelaId) {
            const parcelasDoGrupo = financeiro.despesasVariaveis
                .filter(d => d.grupoParcelaId === item.grupoParcelaId)
                .sort((a, b) => a.parcelaAtual - b.parcelaAtual);
            
            const parcelasPagas = parcelasDoGrupo.filter(p => p.pago).length;
            const parcelasPendentes = parcelasDoGrupo.filter(p => !p.pago).length;
            const totalAtual = parcelasDoGrupo.length;
            
            body.innerHTML = `
                <div class="info-box" style="margin-bottom: 15px; padding: 12px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border-left: 3px solid #3498db;">
                    <strong>üìã Parcela ${item.parcelaAtual}/${totalAtual}</strong><br>
                    <small style="color: rgba(255,255,255,0.6);">
                        ‚úÖ ${parcelasPagas} pagas | ‚è≥ ${parcelasPendentes} pendentes
                    </small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <input type="text" id="editDescricao" value="${item.descricao}">
                    </div>
                    <div class="form-group">
                        <label>Valor da Parcela</label>
                        <input type="number" id="editValor" step="0.01" value="${item.valor}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categoria</label>
                        <input type="text" id="editCategoria" value="${item.categoria}">
                    </div>
                    <div class="form-group">
                        <label>Total de Parcelas</label>
                        <input type="number" id="editTotalParcelas" min="${parcelasPagas || 1}" value="${totalAtual}">
                        <small style="color: rgba(255,255,255,0.4); font-size: 0.75em;">M√≠nimo: ${parcelasPagas || 1} (parcelas j√° pagas)</small>
                    </div>
                </div>
                <div class="form-group form-group-checkbox" style="margin-top: 10px;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editAplicarTodasParcelas" checked>
                        <span>Aplicar altera√ß√µes em TODAS as parcelas pendentes</span>
                    </label>
                </div>
                <div class="form-buttons">
                    <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                    <button class="btn-salvar" onclick="salvarEdicaoParcelada()">Salvar</button>
                </div>
            `;
            document.querySelector('#modalEditar .modal-header h3').textContent = '‚úèÔ∏è Editar Despesa Parcelada';
        } else {
            // Despesa n√£o parcelada - edi√ß√£o simples
            body.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <input type="text" id="editDescricao" value="${item.descricao}">
                    </div>
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="number" id="editValor" step="0.01" value="${item.valor}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categoria</label>
                        <input type="text" id="editCategoria" value="${item.categoria}">
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="editData" value="${item.data}">
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                    <button class="btn-salvar" onclick="salvarEdicaoDespesaVariavel()">Salvar</button>
                </div>
            `;
            document.querySelector('#modalEditar .modal-header h3').textContent = '‚úèÔ∏è Editar Despesa';
        }
        abrirModal('modalEditar');
    }

    // Salvar edi√ß√£o de despesa parcelada
    function salvarEdicaoParcelada() {
        const item = financeiro.despesasVariaveis.find(d => d.id === itemEditando.id);
        if (!item || !item.grupoParcelaId) return;

        const novaDescricao = document.getElementById('editDescricao').value.trim();
        const novoValor = parseFloat(document.getElementById('editValor').value) || item.valor;
        const novaCategoria = document.getElementById('editCategoria').value;
        const novoTotalParcelas = parseInt(document.getElementById('editTotalParcelas').value);
        const aplicarTodas = document.getElementById('editAplicarTodasParcelas').checked;

        // Pegar todas as parcelas do grupo ordenadas
        const parcelasDoGrupo = financeiro.despesasVariaveis
            .filter(d => d.grupoParcelaId === item.grupoParcelaId)
            .sort((a, b) => a.parcelaAtual - b.parcelaAtual);
        
        const totalAtual = parcelasDoGrupo.length;
        const parcelasPagas = parcelasDoGrupo.filter(p => p.pago);
        const parcelasPendentes = parcelasDoGrupo.filter(p => !p.pago);

        // Validar: n√£o pode ter menos parcelas que as j√° pagas
        if (novoTotalParcelas < parcelasPagas.length) {
            alert(`N√£o √© poss√≠vel reduzir para menos de ${parcelasPagas.length} parcelas (j√° pagas).`);
            return;
        }

        // Atualizar parcelas existentes
        if (aplicarTodas) {
            // Atualizar TODAS as parcelas pendentes
            parcelasPendentes.forEach(p => {
                p.descricao = novaDescricao;
                p.valor = novoValor;
                p.categoria = novaCategoria;
                p.totalParcelas = novoTotalParcelas;
            });
            // Atualizar parcelas pagas apenas descri√ß√£o e categoria (n√£o valor)
            parcelasPagas.forEach(p => {
                p.descricao = novaDescricao;
                p.categoria = novaCategoria;
                p.totalParcelas = novoTotalParcelas;
            });
        } else {
            // Atualizar apenas a parcela atual
            item.descricao = novaDescricao;
            item.valor = novoValor;
            item.categoria = novaCategoria;
        }

        // Ajustar n√∫mero de parcelas
        if (novoTotalParcelas > totalAtual) {
            // Adicionar parcelas futuras
            const ultimaParcela = parcelasDoGrupo[parcelasDoGrupo.length - 1];
            const [ano, mes, dia] = ultimaParcela.data.split('-').map(Number);
            
            for (let i = totalAtual + 1; i <= novoTotalParcelas; i++) {
                // Calcular quantos meses adicionar
                const mesesAdicionar = i - totalAtual;
                let novaMes = mes + mesesAdicionar;
                let novoAno = ano;
                
                while (novaMes > 12) {
                    novaMes -= 12;
                    novoAno++;
                }
                
                const dataNova = `${novoAno}-${String(novaMes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                
                financeiro.despesasVariaveis.push({
                    id: gerarId(),
                    descricao: novaDescricao,
                    valor: novoValor,
                    categoria: novaCategoria,
                    data: dataNova,
                    pago: false,
                    dataPagamento: null,
                    comprovante: null,
                    parcelado: true,
                    grupoParcelaId: item.grupoParcelaId,
                    parcelaAtual: i,
                    totalParcelas: novoTotalParcelas
                });
            }
        } else if (novoTotalParcelas < totalAtual) {
            // Remover parcelas pendentes excedentes (apenas as √∫ltimas n√£o pagas)
            const parcelasParaRemover = parcelasPendentes
                .sort((a, b) => b.parcelaAtual - a.parcelaAtual) // Ordenar decrescente
                .slice(0, totalAtual - novoTotalParcelas);
            
            const idsParaRemover = parcelasParaRemover.map(p => p.id);
            financeiro.despesasVariaveis = financeiro.despesasVariaveis.filter(d => !idsParaRemover.includes(d.id));
            
            // Renumerar parcelas restantes
            const parcelasRestantes = financeiro.despesasVariaveis
                .filter(d => d.grupoParcelaId === item.grupoParcelaId)
                .sort((a, b) => new Date(a.data) - new Date(b.data));
            
            parcelasRestantes.forEach((p, idx) => {
                p.parcelaAtual = idx + 1;
                p.totalParcelas = novoTotalParcelas;
            });
        }

        salvarDados();
        fecharModal('modalEditar');
        renderizar();
    }

    function salvarEdicaoDespesaVariavel() {
        const item = financeiro.despesasVariaveis.find(d => d.id === itemEditando.id);
        if (item) {
            item.descricao = document.getElementById('editDescricao').value.trim();
            item.valor = parseFloat(document.getElementById('editValor').value) || item.valor;
            item.categoria = document.getElementById('editCategoria').value;
            item.data = document.getElementById('editData').value;
            salvarDados();
        }
        fecharModal('modalEditar');
        renderizar();
    }

    // ==========================================
    // EMPR√âSTIMOS / D√çVIDAS
    // ==========================================
    
    function salvarEmprestimo() {
        const desc = document.getElementById('emprestimoDescricao').value.trim();
        const principal = parseFloat(document.getElementById('emprestimoPrincipal').value) || 0;
        const juros = parseFloat(document.getElementById('emprestimoJuros').value) || 0;
        const cat = document.getElementById('emprestimoCategoria').value || 'Outros';
        
        if (!desc || !principal) return alert('Preencha os campos obrigat√≥rios!');
        
        financeiro.emprestimos.push({
            id: gerarId(),
            descricao: desc,
            categoria: cat,
            principalOriginal: principal,
            principal: principal,
            taxaJuros: juros,
            jurosAcumulados: 0,
            totalJurosPagos: 0,
            totalAmortizado: 0,
            historico: [],
            arquivado: false,
            dataCriacao: new Date().toISOString()
        });
        
        salvarDados();
        esconderForm('emprestimo');
        renderizar();
    }

    // Gerar juros do m√™s (manual)
    function gerarJurosMes(id) {
        const emp = financeiro.emprestimos.find(e => e.id === id);
        if (!emp || emp.principal <= 0) return;

        const valorJuros = (emp.principal * emp.taxaJuros) / 100;
        emp.jurosAcumulados = (emp.jurosAcumulados || 0) + valorJuros;
        
        emp.historico.push({
            tipo: 'juros_gerado',
            valor: valorJuros,
            data: new Date().toISOString(),
            mesRef: getMesAnoKey()
        });

        salvarDados();
        renderizar();
        mostrarStatus(`Juros de ${formatarMoeda(valorJuros)} adicionados`, 'success');
    }

    // Pagar Juros (N√ÉO reduz principal)
    function abrirModalPagarJuros(id) {
        const emp = financeiro.emprestimos.find(e => e.id === id);
        if (!emp) return;

        emprestimoSelecionado = id;
        const body = document.getElementById('modalPagarJurosBody');
        body.innerHTML = `
            <div class="info-box warning">
                Este pagamento <strong>N√ÉO</strong> reduz a d√≠vida principal. Apenas quita os juros acumulados.
            </div>
            <div class="info-box" style="background:rgba(243,156,18,0.1);border-color:rgba(243,156,18,0.3)">
                <strong>Juros Acumulados:</strong> ${formatarMoeda(emp.jurosAcumulados || 0)}
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Valor a Pagar</label>
                    <input type="number" id="pagarJurosValor" step="0.01" value="${emp.jurosAcumulados || ''}">
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="pagarJurosData" value="${new Date().toISOString().split('T')[0]}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Comprovante (opcional)</label>
                    <input type="file" id="pagarJurosComprovante" accept="image/*,.pdf">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-cancelar" onclick="fecharModal('modalPagarJuros')">Cancelar</button>
                <button class="btn-salvar" onclick="confirmarPagarJuros()">Confirmar</button>
            </div>
        `;
        abrirModal('modalPagarJuros');
    }

    async function confirmarPagarJuros() {
        const emp = financeiro.emprestimos.find(e => e.id === emprestimoSelecionado);
        if (!emp) return;

        const valor = parseFloat(document.getElementById('pagarJurosValor').value) || 0;
        const data = document.getElementById('pagarJurosData').value;

        if (!valor || valor <= 0) return alert('Informe o valor!');

        // Criar comprovante com metadados completos
        const fileInput = document.getElementById('pagarJurosComprovante');
        const comprovante = await criarComprovante(
            fileInput, 
            'juros', 
            valor, 
            emp.descricao + ' - Pagamento de Juros'
        );

        emp.jurosAcumulados = Math.max(0, (emp.jurosAcumulados || 0) - valor);
        emp.totalJurosPagos = (emp.totalJurosPagos || 0) + valor;

        emp.historico.push({
            tipo: 'pagamento_juros',
            valor: valor,
            data: data,
            comprovante: comprovante,
            jurosRestantes: emp.jurosAcumulados
        });

        salvarDados();
        fecharModal('modalPagarJuros');
        renderizar();
        mostrarStatus('Juros pagos: ' + formatarMoeda(valor), 'success');
    }

    // Amortizar (REDUZ principal)
    function abrirModalAmortizar(id) {
        const emp = financeiro.emprestimos.find(e => e.id === id);
        if (!emp) return;

        emprestimoSelecionado = id;
        const body = document.getElementById('modalAmortizarBody');
        body.innerHTML = `
            <div class="info-box info">
                Este pagamento <strong>REDUZ</strong> o valor da d√≠vida principal.
            </div>
            <div class="info-box" style="background:rgba(52,152,219,0.1);border-color:rgba(52,152,219,0.3)">
                <strong>Saldo Devedor:</strong> ${formatarMoeda(emp.principal)}
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Valor a Amortizar</label>
                    <input type="number" id="amortizarValor" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="amortizarData" value="${new Date().toISOString().split('T')[0]}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Comprovante (opcional)</label>
                    <input type="file" id="amortizarComprovante" accept="image/*,.pdf">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-cancelar" onclick="fecharModal('modalAmortizar')">Cancelar</button>
                <button class="btn-salvar" onclick="confirmarAmortizar()">Confirmar</button>
            </div>
        `;
        abrirModal('modalAmortizar');
    }

    async function confirmarAmortizar() {
        const emp = financeiro.emprestimos.find(e => e.id === emprestimoSelecionado);
        if (!emp) return;

        const valor = parseFloat(document.getElementById('amortizarValor').value) || 0;
        const data = document.getElementById('amortizarData').value;

        if (!valor || valor <= 0) return alert('Informe o valor!');
        if (valor > emp.principal) return alert('Valor maior que a d√≠vida atual!');

        // Criar comprovante com metadados completos
        const fileInput = document.getElementById('amortizarComprovante');
        const comprovante = await criarComprovante(
            fileInput, 
            'amortizacao', 
            valor, 
            emp.descricao + ' - Amortiza√ß√£o'
        );

        emp.principal = emp.principal - valor;
        emp.totalAmortizado = (emp.totalAmortizado || 0) + valor;

        emp.historico.push({
            tipo: 'amortizacao',
            valor: valor,
            data: data,
            comprovante: comprovante,
            saldoRestante: emp.principal
        });

        // Arquivar automaticamente se quitado
        if (emp.principal <= 0 && (emp.jurosAcumulados || 0) <= 0) {
            emp.arquivado = true;
            emp.arquivadoEm = new Date().toISOString();
            financeiro.arquivados.emprestimos.push(emp);
            mostrarStatus('üéâ D√≠vida quitada e arquivada!', 'success');
        } else {
            mostrarStatus('Amortiza√ß√£o: ' + formatarMoeda(valor), 'success');
        }

        salvarDados();
        fecharModal('modalAmortizar');
        renderizar();
    }

    function editarEmprestimo(id) {
        const emp = financeiro.emprestimos.find(e => e.id === id);
        if (!emp) return;

        emprestimoSelecionado = id;
        const body = document.getElementById('modalEditarBody');
        body.innerHTML = `
            <div class="info-box warning">
                ‚ö†Ô∏è Altera√ß√µes no principal n√£o afetam o hist√≥rico de pagamentos.
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Credor / Descri√ß√£o</label>
                    <input type="text" id="editEmpDescricao" value="${emp.descricao}">
                </div>
                <div class="form-group">
                    <label>Valor Principal</label>
                    <input type="number" id="editEmpPrincipal" step="0.01" value="${emp.principal}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Taxa de Juros (%)</label>
                    <input type="number" id="editEmpJuros" step="0.1" value="${emp.taxaJuros}">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="editEmpCategoria" value="${emp.categoria}">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn-salvar" onclick="salvarEdicaoEmprestimo()">Salvar</button>
            </div>
        `;
        document.querySelector('#modalEditar .modal-header h3').textContent = '‚úèÔ∏è Editar Empr√©stimo';
        abrirModal('modalEditar');
    }

    function salvarEdicaoEmprestimo() {
        const emp = financeiro.emprestimos.find(e => e.id === emprestimoSelecionado);
        if (!emp) return;

        emp.descricao = document.getElementById('editEmpDescricao').value.trim();
        emp.principal = parseFloat(document.getElementById('editEmpPrincipal').value) || emp.principal;
        emp.taxaJuros = parseFloat(document.getElementById('editEmpJuros').value) || emp.taxaJuros;
        emp.categoria = document.getElementById('editEmpCategoria').value;

        emp.historico.push({
            tipo: 'edicao',
            data: new Date().toISOString(),
            descricao: 'Dados editados manualmente'
        });

        salvarDados();
        fecharModal('modalEditar');
        renderizar();
    }

    function deletarEmprestimo(id) {
        if (!confirm('Excluir este empr√©stimo e todo seu hist√≥rico?')) return;
        financeiro.emprestimos = financeiro.emprestimos.filter(e => e.id !== id);
        salvarDados();
        renderizar();
    }

    // ==========================================
    // ECONOMIAS
    // ==========================================
    
    function salvarEconomia() {
        const desc = document.getElementById('economiaDescricao').value.trim();
        const valor = parseFloat(document.getElementById('economiaValor').value) || 0;
        const cat = document.getElementById('economiaCategoria').value || 'Outros';
        const data = document.getElementById('economiaData').value;
        
        if (!desc || !valor || !data) return alert('Preencha todos os campos!');
        
        financeiro.economias.push({
            id: gerarId(),
            descricao: desc,
            valor: valor,
            categoria: cat,
            data: data
        });
        
        salvarDados();
        esconderForm('economia');
        renderizar();
    }

    function deletarEconomia(id) {
        if (!confirm('Excluir esta economia?')) return;
        financeiro.economias = financeiro.economias.filter(e => e.id !== id);
        salvarDados();
        renderizar();
    }

    function editarEconomia(id) {
        const item = financeiro.economias.find(e => e.id === id);
        if (!item) return;

        itemEditando = { tipo: 'economia', id: id };
        const body = document.getElementById('modalEditarBody');
        body.innerHTML = `
            <div class="form-row">
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="editDescricao" value="${item.descricao}">
                </div>
                <div class="form-group">
                    <label>Valor</label>
                    <input type="number" id="editValor" step="0.01" value="${item.valor}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="editCategoria" value="${item.categoria}">
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="editData" value="${item.data}">
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn-cancelar" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn-salvar" onclick="salvarEdicaoEconomia()">Salvar</button>
            </div>
        `;
        document.querySelector('#modalEditar .modal-header h3').textContent = '‚úèÔ∏è Editar Economia';
        abrirModal('modalEditar');
    }

    function salvarEdicaoEconomia() {
        const item = financeiro.economias.find(e => e.id === itemEditando.id);
        if (item) {
            item.descricao = document.getElementById('editDescricao').value.trim();
            item.valor = parseFloat(document.getElementById('editValor').value) || item.valor;
            item.categoria = document.getElementById('editCategoria').value;
            item.data = document.getElementById('editData').value;
            salvarDados();
        }
        fecharModal('modalEditar');
        renderizar();
    }

    // ==========================================
    // RENDERIZA√á√ÉO
    // ==========================================
    
    function renderizar() {
        if (viewMode === 'arquivados') {
            renderizarArquivados();
            return;
        }

        const receitasMes = filtrarPorMes(financeiro.receitas);
        const fixasMes = getDespesasFixasMes();
        const variaveisMes = filtrarPorMes(financeiro.despesasVariaveis);
        const economiasMes = filtrarPorMes(financeiro.economias);
        const emprestimosAtivos = financeiro.emprestimos.filter(e => !e.arquivado);

        // C√°lculos do m√™s
        const totalRecebido = receitasMes.filter(r => r.recebido).reduce((s, r) => s + r.valor, 0);
        const totalPagoFixas = fixasMes.filter(d => d.pago).reduce((s, d) => s + d.valor, 0);
        const totalPagoVar = variaveisMes.filter(d => d.pago).reduce((s, d) => s + d.valor, 0);
        const totalPago = totalPagoFixas + totalPagoVar;
        const totalDespesasMes = fixasMes.reduce((s, d) => s + d.valor, 0) + variaveisMes.reduce((s, d) => s + d.valor, 0);
        const totalEconomiaMes = economiasMes.reduce((s, e) => s + e.valor, 0);

        // Atualizar resumo do m√™s
        document.getElementById('totalRecebido').textContent = formatarMoeda(totalRecebido);
        document.getElementById('totalPago').textContent = formatarMoeda(totalPago);
        document.getElementById('totalDespesasMes').textContent = formatarMoeda(totalDespesasMes);
        document.getElementById('totalEconomia').textContent = formatarMoeda(totalEconomiaMes);

        // Subtotais
        document.getElementById('subtotalFixas').textContent = `(${formatarMoeda(totalPagoFixas)})`;
        document.getElementById('subtotalVariaveis').textContent = `(${formatarMoeda(totalPagoVar)})`;
        document.getElementById('subtotalEconomias').textContent = `(${formatarMoeda(totalEconomiaMes)})`;

        // Totais gerais acumulados
        const totalRecebidoGeral = financeiro.receitas.filter(r => r.recebido).reduce((s, r) => s + r.valor, 0);
        const totalPagoGeralFixas = Object.values(financeiro.despesasFixasMes).flat().filter(d => d.pago).reduce((s, d) => s + d.valor, 0);
        const totalPagoGeralVar = financeiro.despesasVariaveis.filter(d => d.pago).reduce((s, d) => s + d.valor, 0);
        const totalEconomiaGeral = financeiro.economias.reduce((s, e) => s + e.valor, 0);

        document.getElementById('totalRecebidoFinal').textContent = formatarMoeda(totalRecebidoGeral);
        document.getElementById('totalPagoFinal').textContent = formatarMoeda(totalPagoGeralFixas + totalPagoGeralVar);
        document.getElementById('totalEconomiaFinal').textContent = formatarMoeda(totalEconomiaGeral);

        // === TABELA RECEITAS ===
        const receitasTable = document.getElementById('receitasTable');
        document.getElementById('emptyReceitas').style.display = receitasMes.length ? 'none' : 'block';
        receitasTable.innerHTML = receitasMes.map(r => `
            <tr class="${r.recebido ? 'done' : ''}">
                <td><input type="checkbox" class="checkbox-status" ${r.recebido ? 'checked' : ''} onchange="toggleRecebido(${r.id})"></td>
                <td class="descricao">${r.descricao}</td>
                <td><span class="categoria">${r.categoria}</span></td>
                <td>${formatarData(r.data)}</td>
                <td class="valor-positivo">${formatarMoeda(r.valor)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" onclick="editarReceita(${r.id})" title="Editar">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-arquivar" onclick="arquivarReceita(${r.id})" title="Arquivar">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 8v13H3V8"></path>
                                <path d="M1 3h22v5H1z"></path>
                                <path d="M10 12h4"></path>
                            </svg>
                        </button>
                        <button class="btn-delete" onclick="deletarReceita(${r.id})" title="Excluir">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        // === TABELA DESPESAS FIXAS ===
        const fixasTable = document.getElementById('despesasFixasTable');
        document.getElementById('emptyDespesasFixas').style.display = fixasMes.length ? 'none' : 'block';
        fixasTable.innerHTML = fixasMes.map((d, idx) => {
            const status = getStatusVencimento(d.data, d.pago);
            const temComprovante = d.comprovante !== null && d.comprovante !== undefined;
            return `
                <tr class="${d.pago ? 'done' : ''} ${status.classe}">
                    <td><input type="checkbox" class="checkbox-status" ${d.pago ? 'checked' : ''} onchange="togglePagoFixa(${d.id})"></td>
                    <td class="descricao">
                        ${d.descricao}
                        <span class="badge recorrente">üîÑ</span>
                        ${temComprovante ? '<span class="badge comprovante">üìé</span>' : ''}
                    </td>
                    <td><span class="categoria">${d.categoria}</span></td>
                    <td>${formatarData(d.data)} ${status.badge}</td>
                    <td class="valor-negativo">${formatarMoeda(d.valor)}</td>
                    <td>
                        <div class="action-buttons">
                            ${temComprovante ? `
                                <button class="btn-comprovante" onclick="verComprovanteFixa(${d.id})" title="Ver Comprovante">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                    </svg>
                                </button>
                            ` : ''}
                            <button class="btn-edit" onclick="editarDespesaFixaModelo(${d.modeloId})" title="Editar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="encerrarDespesaFixa(${d.modeloId})" title="Encerrar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // === TABELA DESPESAS VARI√ÅVEIS ===
        const variaveisTable = document.getElementById('despesasVariaveisTable');
        document.getElementById('emptyDespesasVariaveis').style.display = variaveisMes.length ? 'none' : 'block';
        variaveisTable.innerHTML = variaveisMes.map(d => {
            const status = getStatusVencimento(d.data, d.pago);
            const temComprovante = d.comprovante !== null && d.comprovante !== undefined;
            
            // Calcular progresso de parcelas
            let parcelaHtml = '';
            let valorTotalParcelado = '';
            if (d.parcelado && d.totalParcelas && d.grupoParcelaId) {
                // Contar parcelas pagas do mesmo grupo
                const parcelasDoGrupo = financeiro.despesasVariaveis.filter(dv => dv.grupoParcelaId === d.grupoParcelaId);
                const parcelasPagas = parcelasDoGrupo.filter(p => p.pago).length;
                const totalParcelasAtual = parcelasDoGrupo.length;
                const percentPago = Math.round((parcelasPagas / totalParcelasAtual) * 100);
                const valorTotal = d.valor * totalParcelasAtual;
                const valorPago = d.valor * parcelasPagas;
                const valorRestante = valorTotal - valorPago;
                
                valorTotalParcelado = `<small style="color: rgba(255,255,255,0.4); display: block; font-size: 0.75em;">Total: ${formatarMoeda(valorTotal)}</small>`;
                
                // Determinar cor da barra baseado no progresso
                let barColor = '#3498db'; // Azul padr√£o
                if (percentPago >= 100) {
                    barColor = '#2ecc71'; // Verde quando quitado
                } else if (percentPago >= 75) {
                    barColor = '#27ae60'; // Verde mais escuro
                } else if (percentPago >= 50) {
                    barColor = '#f39c12'; // Amarelo
                }
                
                parcelaHtml = `
                    <div class="parcela-progress">
                        <div class="parcela-info">
                            <span class="parcela-label">${parcelasPagas}/${totalParcelasAtual} pagas</span>
                            <span class="parcela-percent">${percentPago}%</span>
                        </div>
                        <div class="parcela-bar">
                            <div class="parcela-bar-fill" style="width: ${percentPago}%; background: linear-gradient(90deg, ${barColor} 0%, ${barColor}cc 100%);"></div>
                        </div>
                        ${percentPago < 100 ? `<small style="color: rgba(255,255,255,0.35); font-size: 0.7em;">Restam: ${formatarMoeda(valorRestante)}</small>` : '<small style="color: #2ecc71; font-size: 0.7em;">‚úì Quitado</small>'}
                    </div>
                `;
            }
            
            return `
                <tr class="${d.pago ? 'done' : ''} ${status.classe}">
                    <td><input type="checkbox" class="checkbox-status" ${d.pago ? 'checked' : ''} onchange="togglePagoVariavel(${d.id})"></td>
                    <td class="descricao">
                        ${d.descricao}
                        ${d.parcelado ? `<span class="badge parcela">${d.parcelaAtual}/${d.totalParcelas}</span>` : ''}
                        ${temComprovante ? '<span class="badge comprovante">üìé</span>' : ''}
                        ${parcelaHtml}
                    </td>
                    <td><span class="categoria">${d.categoria}</span></td>
                    <td>${formatarData(d.data)} ${status.badge}</td>
                    <td class="valor-negativo">
                        ${formatarMoeda(d.valor)}
                        ${valorTotalParcelado}
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${temComprovante ? `
                                <button class="btn-comprovante" onclick="verComprovanteVariavel(${d.id})" title="Ver Comprovante">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                    </svg>
                                </button>
                            ` : ''}
                            <button class="btn-edit" onclick="editarDespesaVariavel(${d.id})" title="Editar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            ${d.parcelado ? `
                                <button class="btn-delete" onclick="deletarTodasParcelas(${d.id})" title="Excluir todas parcelas">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            ` : `
                                <button class="btn-delete" onclick="deletarDespesaVariavel(${d.id})" title="Excluir">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            `}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // === CARDS EMPR√âSTIMOS ===
        const empContainer = document.getElementById('emprestimosContainer');
        document.getElementById('emptyEmprestimos').style.display = emprestimosAtivos.length ? 'none' : 'block';
        empContainer.innerHTML = emprestimosAtivos.map(e => {
            const percentQuitado = e.principalOriginal > 0 ? Math.round(((e.principalOriginal - e.principal) / e.principalOriginal) * 100) : 0;
            const temJurosPendentes = (e.jurosAcumulados || 0) > 0;

            return `
                <div class="emprestimo-card">
                    <div class="emprestimo-card-header">
                        <div class="emprestimo-card-title">
                            ${e.descricao}
                            ${temJurosPendentes ? '<span class="badge juros-pendente">‚ö†Ô∏è Juros Pendentes</span>' : ''}
                            <small>
                                <span class="categoria">${e.categoria}</span> ‚Ä¢ Taxa: ${e.taxaJuros}% a.m.
                            </small>
                        </div>
                        <div class="emprestimo-card-acoes">
                            <button class="btn-edit" onclick="editarEmprestimo(${e.id})" title="Editar">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="deletarEmprestimo(${e.id})" title="Excluir">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="emprestimo-valores">
                        <div class="emprestimo-valor-item">
                            <label>D√≠vida Original</label>
                            <div class="valor principal">${formatarMoeda(e.principalOriginal)}</div>
                        </div>
                        <div class="emprestimo-valor-item">
                            <label>Saldo Devedor</label>
                            <div class="valor saldo">${formatarMoeda(e.principal)}</div>
                        </div>
                        <div class="emprestimo-valor-item">
                            <label>Juros Acumulados</label>
                            <div class="valor juros-acum">${formatarMoeda(e.jurosAcumulados || 0)}</div>
                        </div>
                        <div class="emprestimo-valor-item">
                            <label>Juros Pagos</label>
                            <div class="valor juros-pagos">${formatarMoeda(e.totalJurosPagos || 0)}</div>
                        </div>
                        <div class="emprestimo-valor-item">
                            <label>Total Amortizado</label>
                            <div class="valor amortizado">${formatarMoeda(e.totalAmortizado || 0)}</div>
                        </div>
                    </div>

                    <div class="emprestimo-progress">
                        <label>Progresso de Quita√ß√£o: ${percentQuitado}%</label>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: ${percentQuitado}%"></div>
                        </div>
                    </div>

                    <div class="emprestimo-acoes-rapidas">
                        <button class="btn-gerar-juros" onclick="gerarJurosMes(${e.id})">üìä Gerar Juros</button>
                        <button class="btn-juros" onclick="abrirModalPagarJuros(${e.id})">üí∞ Pagar Juros</button>
                        <button class="btn-amortizar" onclick="abrirModalAmortizar(${e.id})">üìâ Amortizar</button>
                    </div>
                </div>
            `;
        }).join('');

        // === TABELA ECONOMIAS ===
        const economiasTable = document.getElementById('economiasTable');
        document.getElementById('emptyEconomias').style.display = economiasMes.length ? 'none' : 'block';
        economiasTable.innerHTML = economiasMes.map(e => `
            <tr>
                <td class="descricao">${e.descricao}</td>
                <td><span class="categoria">${e.categoria}</span></td>
                <td>${formatarData(e.data)}</td>
                <td class="valor-economia">${formatarMoeda(e.valor)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" onclick="editarEconomia(${e.id})" title="Editar">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-delete" onclick="deletarEconomia(${e.id})" title="Excluir">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        // Renderizar Balan√ßo Geral (ETAPA 4)
        renderizarBalanco(totalRecebido, totalDespesasMes, emprestimosAtivos, totalEconomiaGeral);
    }

    // Renderizar itens arquivados
    function renderizarArquivados() {
        // Limpar tabelas ativas
        document.getElementById('receitasTable').innerHTML = '';
        document.getElementById('despesasFixasTable').innerHTML = '';
        document.getElementById('despesasVariaveisTable').innerHTML = '';
        document.getElementById('economiasTable').innerHTML = '';
        
        // Mostrar empr√©stimos arquivados
        const empArquivados = financeiro.emprestimos.filter(e => e.arquivado);
        const empContainer = document.getElementById('emprestimosContainer');
        
        if (empArquivados.length === 0) {
            empContainer.innerHTML = '<div class="empty-state">Nenhum item arquivado</div>';
            return;
        }

        empContainer.innerHTML = empArquivados.map(e => {
            // Renderizar hist√≥rico com comprovantes
            const historicoComComprovantes = (e.historico || [])
                .filter(h => h.comprovante)
                .map((h, idx) => {
                    const tipoLabel = h.tipo === 'pagamento_juros' ? 'üí∞ Juros' : 
                                     h.tipo === 'amortizacao' ? 'üìâ Amortiza√ß√£o' : h.tipo;
                    return `<button class="comprovante" onclick="verComprovanteHistoricoArquivado(${e.id}, ${e.historico.indexOf(h)})" 
                            title="${tipoLabel} - ${formatarMoeda(h.valor)}" style="margin:2px;">
                            üìé ${tipoLabel}
                    </button>`;
                }).join('');

            return `
                <div class="emprestimo-card arquivado">
                    <div class="emprestimo-card-header">
                        <div class="emprestimo-card-title">
                            ${e.descricao}
                            <span class="badge arquivado">üìÅ Quitado</span>
                            <small>Arquivado em ${formatarData(e.arquivadoEm?.split('T')[0])}</small>
                        </div>
                    </div>
                    <div class="emprestimo-valores">
                        <div class="emprestimo-valor-item">
                            <label>Valor Original</label>
                            <div class="valor">${formatarMoeda(e.principalOriginal)}</div>
                        </div>
                        <div class="emprestimo-valor-item">
                            <label>Total Juros Pagos</label>
                            <div class="valor">${formatarMoeda(e.totalJurosPagos || 0)}</div>
                        </div>
                        <div class="emprestimo-valor-item">
                            <label>Total Amortizado</label>
                            <div class="valor">${formatarMoeda(e.totalAmortizado || 0)}</div>
                        </div>
                    </div>
                    ${historicoComComprovantes ? `
                        <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);">
                            <label style="font-size:0.8em;color:rgba(255,255,255,0.5);display:block;margin-bottom:8px;">üìé Comprovantes Salvos:</label>
                            ${historicoComComprovantes}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');

        // Ocultar empty states
        document.querySelectorAll('.empty-state').forEach(el => el.style.display = 'none');
    }

    // Placeholder para Balan√ßo (ser√° implementado na ETAPA 4)
    function renderizarBalanco(receitaMes, despesaMes, emprestimos, economiaTotal) {
        const balancoGrid = document.getElementById('balancoGrid');
        const sugestoesContainer = document.getElementById('sugestoesContainer');

        // ==========================================
        // C√ÅLCULOS FINANCEIROS
        // ==========================================
        
        // Folga mensal
        const folga = receitaMes - despesaMes;
        
        // Comprometimento da renda (%)
        const comprometimento = receitaMes > 0 
            ? ((despesaMes / receitaMes) * 100).toFixed(1) 
            : 0;
        
        // Total de d√≠vidas ativas
        const totalDividas = emprestimos.reduce((s, e) => s + e.principal, 0);
        
        // Total de juros acumulados
        const totalJurosAcum = emprestimos.reduce((s, e) => s + (e.jurosAcumulados || 0), 0);
        
        // D√≠vida mais alta (prioridade de quita√ß√£o)
        const dividaMaisAlta = emprestimos.length > 0
            ? emprestimos.reduce((max, e) => e.principal > max.principal ? e : max, emprestimos[0])
            : null;
        
        // D√≠vida mais baixa (mais f√°cil de quitar)
        const dividaMaisBaixa = emprestimos.length > 0
            ? emprestimos.reduce((min, e) => e.principal < min.principal ? e : min, emprestimos[0])
            : null;
        
        // D√≠vida com maior taxa de juros (mais cara)
        const dividaMaisCara = emprestimos.length > 0
            ? emprestimos.reduce((max, e) => e.taxaJuros > max.taxaJuros ? e : max, emprestimos[0])
            : null;
        
        // Tempo estimado para quitar todas as d√≠vidas (com folga atual)
        const mesesParaQuitar = folga > 0 && totalDividas > 0
            ? Math.ceil((totalDividas + totalJurosAcum) / folga)
            : null;
        
        // Margem de seguran√ßa (economias vs despesas)
        const mesesDeReserva = despesaMes > 0 
            ? (economiaTotal / despesaMes).toFixed(1)
            : 0;

        // ==========================================
        // RENDERIZAR INDICADORES
        // ==========================================
        
        let indicadoresHTML = '';

        // Comprometimento da Renda
        const comprometimentoStatus = comprometimento > 80 ? 'alerta' : comprometimento > 60 ? 'info' : 'sucesso';
        const comprometimentoMsg = comprometimento > 80 
            ? '‚ö†Ô∏è Renda muito comprometida' 
            : comprometimento > 60 
                ? '‚ö° Aten√ß√£o moderada' 
                : '‚úÖ Boa margem dispon√≠vel';
        
        indicadoresHTML += `
            <div class="balanco-item ${comprometimentoStatus}">
                <h4>üìä Comprometimento da Renda</h4>
                <div class="valor-destaque">${comprometimento}%</div>
                <div class="detalhe">${comprometimentoMsg}</div>
            </div>
        `;

        // Folga Mensal
        indicadoresHTML += `
            <div class="balanco-item ${folga >= 0 ? 'sucesso' : 'alerta'}">
                <h4>üí∞ Folga Mensal</h4>
                <div class="valor-destaque">${formatarMoeda(folga)}</div>
                <div class="detalhe">${folga >= 0 ? 'Dispon√≠vel ap√≥s despesas' : 'D√©ficit - gastos excedem receita'}</div>
            </div>
        `;

        // Total em D√≠vidas
        if (totalDividas > 0) {
            indicadoresHTML += `
                <div class="balanco-item ${totalDividas > receitaMes * 3 ? 'alerta' : 'info'}">
                    <h4>üè¶ Total em D√≠vidas</h4>
                    <div class="valor-destaque">${formatarMoeda(totalDividas)}</div>
                    <div class="detalhe">+ ${formatarMoeda(totalJurosAcum)} em juros acumulados</div>
                </div>
            `;
        }

        // Maior D√≠vida
        if (dividaMaisAlta && emprestimos.length > 0) {
            indicadoresHTML += `
                <div class="balanco-item alerta">
                    <h4>üìà Maior D√≠vida</h4>
                    <div class="valor-destaque">${formatarMoeda(dividaMaisAlta.principal)}</div>
                    <div class="detalhe">${dividaMaisAlta.descricao} (${dividaMaisAlta.taxaJuros}% a.m.)</div>
                </div>
            `;
        }

        // Menor D√≠vida (se houver mais de uma)
        if (dividaMaisBaixa && emprestimos.length > 1 && dividaMaisBaixa.id !== dividaMaisAlta.id) {
            indicadoresHTML += `
                <div class="balanco-item sucesso">
                    <h4>üìâ Menor D√≠vida</h4>
                    <div class="valor-destaque">${formatarMoeda(dividaMaisBaixa.principal)}</div>
                    <div class="detalhe">${dividaMaisBaixa.descricao} - Mais f√°cil de quitar</div>
                </div>
            `;
        }

        // Tempo para Quitar
        if (mesesParaQuitar) {
            const anos = Math.floor(mesesParaQuitar / 12);
            const meses = mesesParaQuitar % 12;
            const tempoTexto = anos > 0 
                ? `${anos} ano${anos > 1 ? 's' : ''} e ${meses} m√™s${meses !== 1 ? 'es' : ''}`
                : `${meses} m√™s${meses !== 1 ? 'es' : ''}`;
            
            indicadoresHTML += `
                <div class="balanco-item ${mesesParaQuitar > 24 ? 'alerta' : 'info'}">
                    <h4>‚è±Ô∏è Tempo para Quitar D√≠vidas</h4>
                    <div class="valor-destaque">${tempoTexto}</div>
                    <div class="detalhe">Estimativa com folga mensal atual</div>
                </div>
            `;
        }

        // Reserva de Emerg√™ncia
        indicadoresHTML += `
            <div class="balanco-item ${mesesDeReserva >= 6 ? 'sucesso' : mesesDeReserva >= 3 ? 'info' : 'alerta'}">
                <h4>üõ°Ô∏è Reserva de Emerg√™ncia</h4>
                <div class="valor-destaque">${mesesDeReserva} meses</div>
                <div class="detalhe">${
                    mesesDeReserva >= 6 
                        ? '‚úÖ Reserva saud√°vel' 
                        : mesesDeReserva >= 3 
                            ? '‚ö° Reserva moderada' 
                            : '‚ö†Ô∏è Construa sua reserva'
                }</div>
            </div>
        `;

        balancoGrid.innerHTML = indicadoresHTML;

        // ==========================================
        // SUGEST√ïES INTELIGENTES
        // ==========================================
        
        let sugestoes = [];

        // Sugest√£o: Juros acumulados pendentes
        if (totalJurosAcum > 0) {
            sugestoes.push({
                icon: '‚ö†Ô∏è',
                prioridade: 1,
                texto: `Voc√™ tem <strong>${formatarMoeda(totalJurosAcum)}</strong> em juros acumulados. Priorize quit√°-los para evitar o efeito bola de neve!`
            });
        }

        // Sugest√£o: Pode quitar d√≠vida menor
        if (dividaMaisBaixa && folga >= dividaMaisBaixa.principal) {
            sugestoes.push({
                icon: 'üéØ',
                prioridade: 2,
                texto: `Com sua folga atual, voc√™ pode <strong>quitar "${dividaMaisBaixa.descricao}"</strong> este m√™s e eliminar uma d√≠vida!`
            });
        }

        // Sugest√£o: Cobrir juros + amortizar
        if (folga > 0 && dividaMaisCara && dividaMaisCara.taxaJuros > 0) {
            const jurosMensal = (dividaMaisCara.principal * dividaMaisCara.taxaJuros) / 100;
            if (folga > jurosMensal) {
                const sobraParaAmortizar = folga - jurosMensal;
                sugestoes.push({
                    icon: 'üí°',
                    prioridade: 3,
                    texto: `Voc√™ pode cobrir os juros de "${dividaMaisCara.descricao}" (<strong>${formatarMoeda(jurosMensal)}</strong>) e ainda amortizar <strong>${formatarMoeda(sobraParaAmortizar)}</strong>.`
                });
            }
        }

        // Sugest√£o: D√≠vida mais cara primeiro
        if (dividaMaisCara && emprestimos.length > 1 && dividaMaisCara.taxaJuros > 5) {
            sugestoes.push({
                icon: 'üî•',
                prioridade: 4,
                texto: `"${dividaMaisCara.descricao}" tem a maior taxa (<strong>${dividaMaisCara.taxaJuros}% a.m.</strong>). Priorize amortiz√°-la para economizar em juros.`
            });
        }

        // Sugest√£o: Economias superam d√≠vidas
        if (economiaTotal > totalDividas && totalDividas > 0) {
            sugestoes.push({
                icon: '‚ú®',
                prioridade: 2,
                texto: `Suas economias (<strong>${formatarMoeda(economiaTotal)}</strong>) superam suas d√≠vidas. Considere quitar e eliminar os juros de uma vez!`
            });
        }

        // Sugest√£o: Renda muito comprometida
        if (comprometimento > 80) {
            sugestoes.push({
                icon: 'üî¥',
                prioridade: 1,
                texto: `Sua renda est√° <strong>${comprometimento}% comprometida</strong>. Avalie cortar despesas vari√°veis ou renegociar d√≠vidas.`
            });
        }

        // Sugest√£o: D√©ficit mensal
        if (folga < 0) {
            sugestoes.push({
                icon: 'üö®',
                prioridade: 0,
                texto: `Voc√™ est√° no <strong>vermelho</strong> este m√™s (${formatarMoeda(folga)}). Revise despesas urgentemente ou busque renda extra.`
            });
        }

        // Sugest√£o: Construir reserva
        if (mesesDeReserva < 3 && folga > 0 && totalDividas === 0) {
            sugestoes.push({
                icon: 'üõ°Ô∏è',
                prioridade: 3,
                texto: `Sua reserva cobre apenas <strong>${mesesDeReserva} meses</strong>. O ideal √© ter 6 meses de despesas guardados.`
            });
        }

        // Sugest√£o: Adiantar parcelas
        if (mesesParaQuitar && mesesParaQuitar > 12 && folga > 0) {
            const mesesReduzidos = Math.floor(mesesParaQuitar * 0.2);
            sugestoes.push({
                icon: '‚ö°',
                prioridade: 5,
                texto: `Aumentando 20% nos pagamentos mensais, voc√™ pode reduzir <strong>${mesesReduzidos} meses</strong> do tempo de quita√ß√£o.`
            });
        }

        // Sugest√£o padr√£o se tudo estiver bem
        if (sugestoes.length === 0) {
            sugestoes.push({
                icon: '‚úÖ',
                prioridade: 10,
                texto: 'Suas finan√ßas est√£o equilibradas! Continue monitorando e mantenha o controle.'
            });
        }

        // Ordenar por prioridade e renderizar
        sugestoes.sort((a, b) => a.prioridade - b.prioridade);
        
        sugestoesContainer.innerHTML = sugestoes.slice(0, 5).map(s => `
            <div class="sugestao-item">
                <span class="icon">${s.icon}</span>
                <span>${s.texto}</span>
            </div>
        `).join('');
    }

    // ==========================================
    // PERSIST√äNCIA (localStorage + Supabase)
    // ==========================================
    
    function salvarDados() {
        localStorage.setItem('financeiro_v5', JSON.stringify(financeiro));
        salvarSupabase();
    }

    async function salvarSupabase() {
        if (!useSupabase) return;
        try {
            const { error } = await supabaseClient.from('financeiro').upsert({
                id: USER_ID,
                user_id: USER_ID,
                dados: financeiro,
                updated_at: new Date().toISOString()
            });
            if (error) {
                console.error('Erro Supabase:', error);
                mostrarStatus('Erro ao sincronizar', 'error');
            } else {
                mostrarStatus('Sincronizado ‚úì', 'success');
            }
        } catch (e) {
            console.error('Exce√ß√£o Supabase:', e);
        }
    }

    async function carregarSupabase() {
        if (!useSupabase) return false;
        try {
            const { data, error } = await supabaseClient
                .from('financeiro')
                .select('*')
                .eq('user_id', USER_ID)
                .maybeSingle();

            if (error) {
                console.error('Erro ao carregar:', error);
                return false;
            }

            if (data?.dados) {
                // Mesclar dados preservando estrutura
                financeiro = {
                    ...dadosVazios,
                    ...data.dados,
                    arquivados: { ...dadosVazios.arquivados, ...data.dados.arquivados }
                };
                localStorage.setItem('financeiro_v5', JSON.stringify(financeiro));
                mostrarStatus('Dados carregados ‚úì', 'success');
                return true;
            }
            return false;
        } catch (e) {
            console.error('Exce√ß√£o:', e);
            return false;
        }
    }

    // ==========================================
    // STATUS DE SINCRONIZA√á√ÉO
    // ==========================================
    
    function mostrarStatus(msg, tipo) {
        let status = document.getElementById('syncStatus');
        if (!status) {
            status = document.createElement('div');
            status.id = 'syncStatus';
            document.body.appendChild(status);
        }
        
        status.textContent = msg;
        status.style.background = tipo === 'success' ? 'rgba(39, 174, 96, 0.95)' : 'rgba(231, 76, 60, 0.95)';
        status.style.opacity = '1';
        
        setTimeout(() => { status.style.opacity = '0'; }, 3000);
    }

    // ==========================================
    // CONTROLES DE M√äS/ANO E VISUALIZA√á√ÉO
    // ==========================================
    
    // Gerar op√ß√µes de ano dinamicamente (10 anos atr√°s at√© 30 anos √† frente)
    function gerarOpcoesAno() {
        const anoAtual = new Date().getFullYear();
        const select = document.getElementById('anoSelect');
        select.innerHTML = '';
        
        // Range ampliado para suportar planejamento de longo prazo
        for (let ano = anoAtual - 10; ano <= anoAtual + 30; ano++) {
            const option = document.createElement('option');
            option.value = ano;
            option.textContent = ano;
            select.appendChild(option);
        }
        
        // Se o ano selecionado n√£o est√° na lista, adiciona dinamicamente
        if (!select.querySelector(`option[value="${anoSelecionado}"]`)) {
            const option = document.createElement('option');
            option.value = anoSelecionado;
            option.textContent = anoSelecionado;
            select.appendChild(option);
        }
        
        select.value = anoSelecionado;
    }

    document.getElementById('mesSelect').addEventListener('change', function() {
        mesSelecionado = this.value;
        gerarInstanciasDespesasFixas();
        renderizar();
    });

    document.getElementById('anoSelect').addEventListener('change', function() {
        anoSelecionado = parseInt(this.value);
        gerarInstanciasDespesasFixas();
        renderizar();
    });

    // Navegar entre meses (suporta qualquer ano)
    function navegarPeriodo(direcao) {
        let mes = parseInt(mesSelecionado);
        let ano = anoSelecionado;
        
        mes += direcao;
        
        if (mes > 12) {
            mes = 1;
            ano++;
        } else if (mes < 1) {
            mes = 12;
            ano--;
        }
        
        mesSelecionado = String(mes).padStart(2, '0');
        anoSelecionado = ano;
        
        // Atualizar seletor de ano se necess√°rio (para anos fora do range inicial)
        const selectAno = document.getElementById('anoSelect');
        if (!selectAno.querySelector(`option[value="${ano}"]`)) {
            const option = document.createElement('option');
            option.value = ano;
            option.textContent = ano;
            selectAno.appendChild(option);
        }
        
        document.getElementById('mesSelect').value = mesSelecionado;
        document.getElementById('anoSelect').value = anoSelecionado;
        
        gerarInstanciasDespesasFixas();
        renderizar();
    }

    // Ir para m√™s atual
    function irParaHoje() {
        const hoje = new Date();
        mesSelecionado = String(hoje.getMonth() + 1).padStart(2, '0');
        anoSelecionado = hoje.getFullYear();
        
        document.getElementById('mesSelect').value = mesSelecionado;
        document.getElementById('anoSelect').value = anoSelecionado;
        
        gerarInstanciasDespesasFixas();
        renderizar();
    }

    document.getElementById('btnAtivos').addEventListener('click', function() {
        viewMode = 'ativos';
        this.classList.add('active');
        document.getElementById('btnArquivados').classList.remove('active');
        renderizar();
    });

    document.getElementById('btnArquivados').addEventListener('click', function() {
        viewMode = 'arquivados';
        this.classList.add('active');
        document.getElementById('btnAtivos').classList.remove('active');
        renderizar();
    });

    // ==========================================
    // INICIALIZA√á√ÉO
    // ==========================================
    
    async function init() {
        // Definir m√™s e ano atual
        const hoje = new Date();
        mesSelecionado = String(hoje.getMonth() + 1).padStart(2, '0');
        anoSelecionado = hoje.getFullYear();
        
        // Gerar op√ß√µes de ano e selecionar atual
        gerarOpcoesAno();
        document.getElementById('mesSelect').value = mesSelecionado;
        document.getElementById('anoSelect').value = anoSelecionado;
        
        // Carregar dados do Supabase (prioridade)
        await carregarSupabase();
        
        // Gerar inst√¢ncias de despesas fixas para o m√™s
        gerarInstanciasDespesasFixas();
        
        // Renderizar interface
        renderizar();
    }

    // Iniciar aplica√ß√£o
    init();
</script>
```

</body>
</html>